
<!DOCTYPE html>
<html lang="en"> <!-- Defaults to light mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reoffy Pakistan</title>

    <!-- PWA Manifest and Theme Color (FIXED PATH) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10B981">

    <!-- iOS PWA Tags (FIXED PATH) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --accent-color: #10B981; --accent-color-dark: #059669; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-screen { display: none; width: 100%; }
        .app-screen.active { display: flex; flex-direction: column; height: 100vh; }
        main.main-content { flex-grow: 1; overflow-y: auto; }
        .app-screen.active.no-flex { display: block; height: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        .mini-loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent-color); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .screen-loader { display: flex; justify-content: center; align-items: center; height: 70vh; }
        .payment-tab.active { border-color: var(--accent-color); background-color: rgba(16, 185, 129, 0.1); }
        .category-item.active div:first-child { background-color: var(--accent-color); }
        .category-item.active div:first-child i, .category-item.active div:first-child span { color: white; }
        
        #nav-sell-button {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 12px;
            z-index: 50;
        }
        #nav-sell-button a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 4rem;
            height: 4rem;
            border-radius: 9999px;
            background-color: var(--accent-color);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 8px 25px -5px rgba(16, 185, 129, 0.4), 0 4px 6px -2px rgba(16, 185, 129, 0.1);
        }
        #nav-sell-button a:hover {
            transform: translateY(-4px) scale(1.05);
            background-color: var(--accent-color-dark);
            box-shadow: 0 12px 30px -5px rgba(16, 185, 129, 0.5);
        }
        #nav-sell-button a i {
            font-size: 2.25rem;
            color: white;
        }
        /* Auth Screen Styles */
        .auth-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        .auth-toggle-buttons {
            display: flex;
            border: 1px solid #333;
            border-radius: 9999px;
            padding: 4px;
            margin-bottom: 2rem;
        }
        .auth-toggle-button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 9999px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            background-color: transparent;
        }
        .auth-toggle-button.active {
            background-color: var(--accent-color);
            color: white;
        }
        /* Chat Bubble Styles */
        .chat-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
        }
        .chat-bubble-sent {
            background-color: var(--accent-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .chat-bubble-received {
            background-color: #e5e7eb; /* light-border */
            color: #1f2937;
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .dark .chat-bubble-received {
            background-color: #1e1e1e; /* dark-surface */
            color: #f3f4f6;
        }
        .chat-bubble-image {
            padding: 0.25rem; /* Reduced padding for image bubbles */
            background-color: transparent;
        }
        .chat-bubble-image img {
            max-width: 100%;
            border-radius: 1rem;
            object-fit: cover;
        }
        /* Skeleton Loader */
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        .skeleton {
            position: relative;
            overflow: hidden;
            background-color: #e2e8f0;
        }
        .dark .skeleton { background-color: #333333; }
        .skeleton::after {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.2) 20%, rgba(255, 255, 255, 0.5) 60%, rgba(255, 255, 255, 0));
            animation: shimmer 2s infinite;
            content: '';
        }
        .dark .skeleton::after {
             background-image: linear-gradient(90deg, rgba(75, 85, 99, 0) 0, rgba(75, 85, 99, 0.2) 20%, rgba(75, 85, 99, 0.5) 60%, rgba(75, 85, 99, 0));
        }
        /* Slider Styles */
        .slider-container {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .slider-wrapper {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }
        .slider-slide {
            flex-shrink: 0;
            width: 100%;
        }
        /* Verified Badge */
        .verified-badge {
            color: #0d6efd; /* Bootstrap blue for verified tick */
            display: inline-flex;
            align-items: center;
            font-size: 0.9em;
            margin-left: 6px;
        }
        /* Toast Notification (Smaller) */
        #toast-notification {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.6rem 1.2rem;
            border-radius: 9999px; /* Pill shape */
            color: white;
            font-weight: 500;
            font-size: 0.875rem;
            z-index: 200;
            transition: top 0.4s ease-in-out;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        #toast-notification.show {
            top: 15px;
        }
        #toast-notification.success { background-color: #10B981; }
        #toast-notification.error { background-color: #EF4444; }

        /* Event Banner Animation */
        #event-banner-container.show {
            top: 0;
        }

        /* My Ads Tabs */
        .my-ads-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #6b7280; /* gray-500 */
        }
        .dark .my-ads-tab {
             color: #9ca3af; /* gray-400 */
        }
        .my-ads-tab.active {
            border-bottom-color: var(--accent-color);
            color: var(--accent-color);
        }
        /* Dotted border for referral code */
        .dotted-border {
            border: 2px dashed #9ca3af; /* gray-400 */
        }

    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'accent': '#10B981', 'accent-dark': '#059669', 'dark-bg': '#121212', 'dark-surface': '#1e1e1e',
                        'dark-border': '#333333', 'light-bg': '#f3f4f6', 'light-surface': '#ffffff', 'light-border': '#e5e7eb',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-bg dark:bg-dark-bg">

    <!-- NEW: Event Banner -->
    <div id="event-banner-container" class="fixed top-[-200px] left-0 right-0 z-[150] transition-all duration-500 ease-in-out shadow-lg px-4 pt-2">
        <div class="relative max-w-2xl mx-auto">
            <a id="event-banner-link" href="#" class="block rounded-lg overflow-hidden">
                <img id="event-banner-image" src="" alt="Special Event" class="w-full h-auto object-contain">
            </a>
            <button id="event-banner-close" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-7 h-7 flex items-center justify-center text-lg hover:bg-black/80 transition-colors">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    <!-- END: Event Banner -->

    <div id="toast-notification">Toast Message</div>

    <div class="w-full min-h-screen text-gray-800 dark:text-gray-100 relative">
        
        <!-- SCREEN: Home -->
        <div id="home-screen" class="app-screen active no-flex">
            <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex justify-between items-center sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border space-x-3">
                    <div class="flex-grow relative">
                        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="home-search-input" type="text" placeholder="Search for Mobiles, Cars..." class="w-full bg-light-bg dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg py-2.5 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-accent" onkeyup="performSearch(event)">
                    </div>
                    <i id="theme-toggle" class="bi bi-moon-stars-fill text-xl cursor-pointer text-gray-700 dark:text-gray-300"></i>
                </header>

                <!-- PWA Install Banner -->
                <div id="pwa-install-banner" class="hidden sticky top-[65px] z-10 bg-light-surface dark:bg-dark-surface p-3 shadow-md">
                    <div class="flex items-center justify-between max-w-md mx-auto">
                        <div class="flex items-center">
                            <img src="icons/icon-192x192.png" alt="App Icon" class="w-10 h-10 rounded-lg mr-3">
                            <div>
                                <p class="font-bold text-sm">Install Reoffy Pakistan</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Add to your home screen for a better experience.</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button id="install-app-btn" class="bg-accent text-white font-bold text-sm px-4 py-1.5 rounded-full">Install</button>
                            <button id="close-install-banner-btn" class="ml-2 text-gray-500 dark:text-gray-400 text-2xl"><i class="bi bi-x"></i></button>
                        </div>
                    </div>
                </div>


                <div class="p-4 space-y-6">
                    <!-- Search Results will be shown here -->
                    <div id="search-results-container" class="hidden">
                        <div id="search-results-grid" class="grid grid-cols-2 gap-3"></div>
                        <div id="search-no-results" class="hidden text-center py-10">
                            <i class="bi bi-emoji-frown text-5xl text-gray-400"></i>
                            <p class="mt-4 font-semibold">No Results Found</p>
                            <p class="text-sm text-gray-500">Try searching for something else.</p>
                        </div>
                    </div>
                    
                    <!-- Default Home Content -->
                    <div id="default-home-content">
                        <div id="home-promotions-container" class="w-full h-36 bg-light-surface dark:bg-dark-surface rounded-lg overflow-hidden">
                             <!-- Skeleton/Promotions will be loaded here -->
                        </div>
                        <div id="buy-packages-banner-home" class="bg-gradient-to-r from-accent to-emerald-600 text-white p-3 rounded-lg flex justify-between items-center cursor-pointer mt-6">
                            <div><h3 class="font-bold">Buy Discounted Packages</h3><p class="text-xs">More Credits, More Savings!</p></div>
                            <i class="bi bi-arrow-right-circle-fill text-2xl"></i>
                        </div>
                        <div class="overflow-x-auto no-scrollbar mt-6">
                            <div id="home-category-container" class="flex space-x-6">
                                <!-- Categories will be loaded here -->
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 text-sm text-gray-700 dark:text-gray-300 mt-6">
                            <div class="flex-grow flex items-center bg-light-surface dark:bg-dark-surface p-2 rounded-lg shadow-sm cursor-pointer" onclick="openModal('city-selection-screen', 'home-location-filter-text')">
                                <i class="bi bi-geo-alt-fill text-accent mr-2"></i>
                                <span id="home-location-filter-text">All Pakistan</span>
                            </div>
                             <div class="flex-grow flex items-center bg-light-surface dark:bg-dark-surface p-2 rounded-lg shadow-sm cursor-pointer" onclick="openModal('brand-selection-screen', 'home-brand-filter-text')">
                                <i class="bi bi-tags-fill text-accent mr-2"></i>
                                <span id="home-brand-filter-text">All Brands</span>
                            </div>
                            <div class="flex items-center bg-light-surface dark:bg-dark-surface p-2 rounded-lg shadow-sm cursor-pointer" onclick="openModal('advanced-filters-modal')">
                                <i class="bi bi-sliders mr-2"></i><span>Filters</span>
                            </div>
                        </div>
                        
                        <div id="ads-container">
                             <div class="mt-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-lg font-semibold">Featured Ads</h2>
                                    <span class="text-sm font-semibold text-accent cursor-pointer" onclick="navigateTo('featured-ads-list-screen')">See All</span>
                                </div>
                                <div id="featured-ads-grid" class="grid grid-cols-2 gap-3">
                                    <!-- Ad Skeletons/Cards will be loaded here -->
                                </div>
                            </div>
                            <div class="mt-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-lg font-semibold">Fresh Recommendations</h2>
                                    <span class="text-sm font-semibold text-accent cursor-pointer" onclick="navigateTo('fresh-ads-list-screen')">See All</span>
                                </div>
                                <div id="fresh-recommendations-grid" class="grid grid-cols-2 gap-3">
                                     <!-- Ad Skeletons/Cards will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <div id="no-ads-found-message" class="hidden text-center py-10">
                            <i class="bi bi-search text-5xl text-gray-400"></i>
                            <p class="mt-4 font-semibold">No Ads Found</p>
                            <p class="text-sm text-gray-500">Try adjusting your filters or check back later.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- SCREEN: Featured Ads List -->
        <div id="featured-ads-list-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <div class="flex-grow relative">
                        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="featured-list-search-input" type="text" placeholder="Search in Featured Ads..." class="w-full bg-light-bg dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-accent" onkeyup="renderFeaturedAdsList()">
                    </div>
                </header>
                <div class="p-4">
                    <h1 class="text-xl font-bold mb-4">All Featured Ads</h1>
                    <div id="featured-list-grid" class="grid grid-cols-2 gap-3">
                        <!-- Featured ads will be injected here -->
                    </div>
                    <div id="featured-list-empty-state" class="hidden flex-col items-center justify-center h-[70vh] text-center p-8">
                        <i class="bi bi-star-fill text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                        <h2 class="text-xl font-bold">No Featured Ads Found.</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">Check back later for promoted content.</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- SCREEN: Fresh Ads List -->
        <div id="fresh-ads-list-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <div class="flex-grow relative">
                        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="fresh-list-search-input" type="text" placeholder="Search in Fresh Recommendations..." class="w-full bg-light-bg dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-accent" onkeyup="renderFreshAdsList()">
                    </div>
                </header>
                <div class="p-4">
                    <h1 class="text-xl font-bold mb-4">All Fresh Recommendations</h1>
                    <div id="fresh-list-grid" class="grid grid-cols-2 gap-3">
                        <!-- Fresh ads will be injected here -->
                    </div>
                    <div id="fresh-list-empty-state" class="hidden flex-col items-center justify-center h-[70vh] text-center p-8">
                        <i class="bi bi-cloud-slash-fill text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                        <h2 class="text-xl font-bold">No Ads Found.</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">Try searching for something else.</p>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- SCREEN: Chats -->
        <div id="chats-screen" class="app-screen no-flex">
             <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border"><h1 class="text-xl font-bold">Chats</h1></header>
                <div id="chat-list" class="divide-y divide-light-border dark:divide-dark-border"></div>
                <div id="chat-empty-state" class="flex flex-col items-center justify-center h-[70vh] text-center p-8">
                    <i class="bi bi-chat-dots-fill text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">No messages yet.</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Start a conversation from a product page.</p>
                </div>
            </main>
        </div>

        <!-- SCREEN: Chat Detail -->
        <div id="chat-detail-screen" class="app-screen bg-light-bg dark:bg-dark-bg">
            <header class="p-4 flex items-center space-x-4 bg-light-surface dark:bg-dark-surface z-20 border-b border-light-border dark:border-dark-border flex-shrink-0">
                <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                <img id="chat-detail-avatar" src="" alt="User" class="w-10 h-10 rounded-full object-cover">
                <div>
                    <div class="flex items-center">
                        <h1 id="chat-detail-name" class="font-bold"></h1>
                        <!-- Verified badge will be injected here by JS -->
                    </div>
                    <p id="chat-detail-product" class="text-xs text-gray-500 dark:text-gray-400"></p>
                </div>
            </header>
            <div id="chat-messages-container" class="flex-grow overflow-y-auto p-4 flex flex-col space-y-4"></div>
            <div class="p-2 bg-light-surface dark:bg-dark-surface border-t border-light-border dark:border-dark-border flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <input type="file" id="chat-image-input" class="hidden" accept="image/*" onchange="handleChatImageSelection(event)">
                    <button onclick="document.getElementById('chat-image-input').click()" class="w-12 h-12 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-full flex-shrink-0 flex items-center justify-center"><i class="bi bi-paperclip text-xl"></i></button>
                    <input id="chat-input" type="text" placeholder="Type a message..." class="w-full bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-full py-3 px-4 focus:outline-none focus:ring-2 focus:ring-accent">
                    <button id="chat-send-btn" onclick="sendMessage()" class="w-12 h-12 bg-accent text-white rounded-full flex-shrink-0 flex items-center justify-center"><i class="bi bi-send-fill text-xl"></i></button>
                </div>
            </div>
        </div>
        
        <!-- SCREEN: Sell -->
        <div id="sell-screen" class="app-screen bg-light-bg dark:bg-black no-flex">
             <main class="main-content no-scrollbar">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-black/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-x-lg text-xl cursor-pointer" onclick="navigateTo('home-screen')"></i>
                    <h1 class="text-lg font-semibold">Post your Ad</h1>
                </header>
                <div class="p-4 space-y-6">
                    <div>
                        <label class="text-base font-semibold mb-2 block">Upload Images (up to 5)*</label>
                        <div class="bg-light-surface dark:bg-dark-surface rounded-lg p-4 border border-light-border dark:border-dark-border">
                            <div id="image-preview-container" class="grid grid-cols-3 gap-2 mb-4"></div>
                            <div id="upload-area">
                                <input type="file" id="image-upload-input" multiple accept="image/*" class="hidden">
                                <button onclick="document.getElementById('image-upload-input').click()" class="w-full flex items-center justify-center space-x-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                    <i class="bi bi-camera-fill"></i>
                                    <span>Add Images</span>
                                </button>
                                <p class="text-xs text-center mt-2 text-gray-500">You can upload image files up to 5MB in JPG, JPEG, PNG, or GIF formats.</p>
                            </div>
                        </div>
                    </div>
                     <div>
                        <label for="sell-category" class="text-base font-semibold mb-2 block">Category*</label>
                        <select id="sell-category" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                            <option disabled selected>Select a category</option>
                        </select>
                    </div>
                     <div>
                        <label for="sell-brand-model" class="text-base font-semibold mb-2 block">Brand & Model</label>
                        <input id="sell-brand-model" list="brands-datalist" type="text" placeholder="e.g., Apple iPhone 14 Pro" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        <datalist id="brands-datalist">
                            <!-- Brands from Admin Panel will be populated here -->
                        </datalist>
                    </div>
                     <div>
                        <label for="sell-condition" class="text-base font-semibold mb-2 block">Condition*</label>
                        <select id="sell-condition" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                            <option>New</option>
                            <option>Used</option>
                            <option>Open Box</option>
                            <option>Refurbished</option>
                        </select>
                    </div>
                    <div>
                        <label for="sell-title" class="text-base font-semibold mb-2 block">Title*</label>
                        <input id="sell-title" type="text" placeholder="Enter Ad Title" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label for="sell-description" class="text-base font-semibold mb-2 block">Description</label>
                        <textarea id="sell-description" rows="4" placeholder="Describe the item you are selling" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent"></textarea>
                    </div>
                    <div class="relative">
                        <label for="sell-price" class="text-base font-semibold mb-2 block">Price*</label>
                        <input id="sell-price" type="number" placeholder="Enter price" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 pr-10 focus:outline-none focus:ring-2 focus:ring-accent"><span class="absolute right-4 top-11 text-gray-500">Rs</span>
                    </div>
                    <div>
                        <label class="text-base font-semibold mb-2 block">Location*</label>
                         <div class="flex items-center space-x-2">
                             <div class="flex-grow flex justify-between items-center bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 cursor-pointer" onclick="openModal('city-selection-screen', 'sell-location-text')">
                                <span id="sell-location-text" class="text-gray-500 dark:text-gray-400">Select Location</span>
                                <i class="bi bi-chevron-right text-gray-500"></i>
                            </div>
                            <button onclick="getCurrentLocation('sell-location-text')" class="p-3 bg-accent text-white rounded-lg flex-shrink-0"><i class="bi bi-geo-fill"></i></button>
                         </div>
                    </div>
                    <div>
                        <h3 class="text-base font-semibold mb-2 block">Contact Info</h3>
                        <div class="space-y-4 bg-light-surface dark:bg-dark-surface p-4 rounded-lg">
                             <div>
                                <label for="sell-contact-name" class="text-sm font-medium text-gray-600 dark:text-gray-400">Name</label>
                                <input id="sell-contact-name" type="text" class="w-full bg-gray-200 dark:bg-gray-700 border border-light-border dark:border-dark-border rounded-lg p-3 mt-1 text-gray-500" disabled>
                            </div>
                             <div>
                                <label for="sell-contact-phone" class="text-sm font-medium text-gray-600 dark:text-gray-400">Phone</label>
                                <input id="sell-contact-phone" type="tel" class="w-full bg-gray-200 dark:bg-gray-700 border border-light-border dark:border-dark-border rounded-lg p-3 mt-1 text-gray-500" disabled>
                            </div>
                        </div>
                    </div>
                     <!-- New Payment Details Toggle -->
                    <div class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg">
                        <label for="sell-show-payment" class="flex items-center justify-between cursor-pointer">
                            <span class="font-semibold">Show payment info on ad?</span>
                            <div class="relative">
                                <input type="checkbox" id="sell-show-payment" class="sr-only">
                                <div class="block bg-gray-200 dark:bg-gray-600 w-14 h-8 rounded-full"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                            </div>
                        </label>
                         <p class="text-xs text-gray-500 mt-2">If enabled, your saved Easypaisa/Jazzcash details will be visible to buyers on your ad page. Make sure your details are saved in Settings.</p>
                    </div>
                    <style>
                        input:checked ~ .dot { transform: translateX(100%); background-color: var(--accent-color); }
                        input:checked ~ .block { background-color: rgba(16, 185, 129, 0.5); }
                    </style>
                </div>
                 <div class="sticky bottom-0 p-4 bg-light-surface/80 dark:bg-black/80 backdrop-blur-sm border-t border-light-border dark:border-dark-border">
                    <button onclick="postNewAd()" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg text-lg transition-colors">Post Now</button>
                </div>
            </main>
        </div>

        <!-- SCREEN: Edit Ad -->
        <div id="edit-ad-screen" class="app-screen bg-light-bg dark:bg-black no-flex">
            <main class="main-content no-scrollbar">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-black/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-lg font-semibold">Edit Your Ad</h1>
                </header>
                <div class="p-4 space-y-6">
                    <div>
                        <label class="text-base font-semibold mb-2 block">Images (Cannot be changed)</label>
                        <div class="bg-light-surface dark:bg-dark-surface rounded-lg p-4 border border-light-border dark:border-dark-border">
                            <div id="edit-image-preview-container" class="grid grid-cols-3 gap-2">
                                <!-- Existing images will be shown here -->
                            </div>
                        </div>
                    </div>
                     <div>
                        <label class="text-base font-semibold mb-2 block">Price (Cannot be changed)</label>
                        <div id="edit-price-display" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-light-border dark:border-dark-border rounded-lg p-3"></div>
                    </div>
                    <div>
                        <label class="text-base font-semibold mb-2 block">Category*</label>
                        <select id="edit-category" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </select>
                    </div>
                    <div>
                        <label class="text-base font-semibold mb-2 block">Title*</label>
                        <input id="edit-title" type="text" placeholder="Enter Ad Title" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label class="text-base font-semibold mb-2 block">Description</label>
                        <textarea id="edit-description" rows="4" placeholder="Describe the item you are selling" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent"></textarea>
                    </div>
                    <div>
                        <label class="text-base font-semibold mb-2 block">Location*</label>
                        <div class="flex justify-between items-center bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 cursor-pointer" onclick="openModal('city-selection-screen', 'edit-location-text')">
                            <span id="edit-location-text">Select Location</span>
                            <i class="bi bi-chevron-right text-gray-500"></i>
                        </div>
                    </div>
                </div>
                 <div class="sticky bottom-0 p-4 bg-light-surface/80 dark:bg-black/80 backdrop-blur-sm border-t border-light-border dark:border-dark-border space-y-3">
                    <button onclick="saveAdChanges()" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg text-lg transition-colors">Save Changes</button>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="edit-promote-button" onclick="openBoostModal(event, currentEditingAd.id)" class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2.5 rounded-lg transition-colors">Promote Ad</button>
                        <button onclick="deleteAd()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2.5 rounded-lg transition-colors">Delete Ad</button>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- SCREEN: My Ads -->
        <div id="my-ads-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex justify-between items-center sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border"><h1 class="text-xl font-bold">My Ads</h1></header>
                
                <div class="flex border-b border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface sticky top-[65px] z-10">
                    <button id="my-ads-active-tab" class="my-ads-tab active" onclick="switchMyAdsTab('active')">Active</button>
                    <button id="my-ads-inactive-tab" class="my-ads-tab" onclick="switchMyAdsTab('inactive')">Inactive</button>
                    <button id="my-ads-boosted-tab" class="my-ads-tab" onclick="switchMyAdsTab('boosted')">Boosted</button>
                </div>

                <div id="my-ads-list-container" class="p-4">
                    <div id="my-ads-activation-alert" class="hidden"></div>
                    <div id="my-ads-active-content" class="space-y-3">
                        <!-- User's active ads will be injected here -->
                    </div>
                     <div id="my-ads-inactive-content" class="space-y-3 hidden">
                        <!-- User's inactive ads will be injected here -->
                    </div>
                    <div id="my-ads-boosted-content" class="space-y-3 hidden">
                        <!-- User's boosted ads will be injected here -->
                    </div>
                </div>

                <div id="my-ads-empty-state" class="hidden flex-col items-center justify-center h-[60vh] text-center p-8">
                    <i class="bi bi-file-earmark-post-fill text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h2 id="my-ads-empty-state-title" class="text-xl font-bold">You have no active ads.</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Tap the sell button to post a new ad.</p>
                </div>
            </main>
        </div>

        <!-- SCREEN: Favorite Ads -->
        <div id="favorites-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Favorite Ads</h1>
                </header>
                <div class="p-4">
                    <div id="favorites-grid" class="grid grid-cols-2 gap-3">
                        <!-- Favorite ads will be injected here -->
                    </div>
                    <div id="favorites-empty-state" class="hidden flex-col items-center justify-center h-[70vh] text-center p-8">
                        <i class="bi bi-heart-fill text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                        <h2 class="text-xl font-bold">No favorite ads yet.</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">Tap the heart icon on an ad to save it here.</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- SCREEN: Account -->
        <div id="account-screen" class="app-screen no-flex">
             <!-- This screen's content will be dynamically generated by updateAccountScreenView() -->
        </div>
        
        <!-- SCREEN: Settings -->
        <div id="settings-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Settings</h1>
                </header>
                <div class="p-4 space-y-8">
                    <!-- Personal Information Section -->
                    <div>
                        <h2 class="text-lg font-bold mb-4">Personal Information</h2>
                        <div class="bg-light-surface dark:bg-dark-surface rounded-lg p-4 space-y-4">
                            <div>
                                <label class="text-sm text-gray-600 dark:text-gray-400">Username</label>
                                <input id="settings-username" type="text" class="w-full mt-1 bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg p-3">
                            </div>
                            <div>
                                <label class="text-sm text-gray-600 dark:text-gray-400">Email</label>
                                <input id="settings-email" type="email" class="w-full mt-1 bg-gray-200 dark:bg-gray-700 border border-light-border dark:border-dark-border rounded-lg p-3 text-gray-500" disabled>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600 dark:text-gray-400">Phone Number (for WhatsApp)</label>
                                <input id="settings-phone" type="tel" class="w-full mt-1 bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg p-3">
                            </div>
                            <button onclick="savePersonalInformation()" class="w-full bg-accent text-white font-bold py-3 rounded-lg mt-2">Save Info</button>
                        </div>
                    </div>

                    <!-- Payment Methods Section -->
                    <div>
                        <h2 class="text-lg font-bold mb-4">Payment Methods</h2>
                        <div id="payment-methods-container" class="bg-light-surface dark:bg-dark-surface rounded-lg p-4 space-y-6">
                            <!-- Payment details will be loaded here -->
                             <div class="space-y-4">
                                <h3 class="font-semibold text-accent">Easypaisa Details</h3>
                                <div>
                                    <label class="text-sm text-gray-600 dark:text-gray-400">Account Title</label>
                                    <input id="easypaisa-name" type="text" placeholder="e.g. John Doe" class="w-full mt-1 bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg p-3">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-600 dark:text-gray-400">Account Number</label>
                                    <input id="easypaisa-number" type="tel" placeholder="e.g. 03xxxxxxxxx" class="w-full mt-1 bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg p-3">
                                </div>
                            </div>
                             <div class="space-y-4">
                                <h3 class="font-semibold text-accent">Jazzcash Details</h3>
                                <div>
                                    <label class="text-sm text-gray-600 dark:text-gray-400">Account Title</label>
                                    <input id="jazzcash-name" type="text" placeholder="e.g. John Doe" class="w-full mt-1 bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg p-3">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-600 dark:text-gray-400">Account Number</label>
                                    <input id="jazzcash-number" type="tel" placeholder="e.g. 03xxxxxxxxx" class="w-full mt-1 bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg p-3">
                                </div>
                            </div>
                            <button onclick="savePaymentDetails()" class="w-full bg-accent text-white font-bold py-3 rounded-lg mt-2">Save Payment Details</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- NEW SCREEN: Invite Friends -->
        <div id="invite-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Invite Friends</h1>
                </header>
                <div class="p-6 text-center">
                    <i class="bi bi-gift-fill text-6xl text-accent"></i>
                    <h2 class="text-2xl font-bold mt-4">Invite & Earn Rewards!</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Share your referral code with friends. When they sign up, you'll both get rewards as defined by the platform!</p>
                    
                    <div class="my-8">
                        <p class="text-sm text-gray-500 mb-2">Your Unique Referral Code</p>
                        <div id="referral-code-display" class="dotted-border p-4 rounded-lg text-2xl font-mono tracking-widest font-bold text-gray-800 dark:text-gray-200">
                            LOADING...
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="copyReferralCode()" class="w-full bg-accent text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="bi bi-clipboard-check-fill"></i>
                            <span>Copy Code</span>
                        </button>
                        <button onclick="copyReferralLink()" class="w-full bg-gray-700 text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="bi bi-link-45deg"></i>
                            <span>Copy Referral Link</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>


        <!-- SCREEN: LOGIN / SIGNUP (Standalone for deep linking or specific redirects) -->
        <div id="auth-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar">
                <header class="p-4 flex items-center sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold ml-4">Welcome</h1>
                </header>
                <div class="auth-container">
                    <div class="auth-toggle-buttons bg-light-surface dark:bg-dark-surface">
                        <button id="auth-login-btn" class="auth-toggle-button active" onclick="switchAuthForm('login')">Login</button>
                        <button id="auth-signup-btn" class="auth-toggle-button" onclick="switchAuthForm('signup')">Sign Up</button>
                    </div>

                    <!-- Login Form -->
                    <div id="login-form-container" class="space-y-5">
                        <button onclick="handleGoogleAuth()" class="w-full flex items-center justify-center space-x-3 bg-white dark:bg-gray-800 border border-light-border dark:border-dark-border rounded-lg py-3 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            <img src="https://www.vectorlogo.zone/logos/google/google-icon.svg" class="w-6 h-6" alt="Google Icon">
                            <span>Continue with Google</span>
                        </button>
                        <div class="flex items-center text-center"><span class="flex-grow border-t border-light-border dark:border-dark-border"></span><span class="px-3 text-sm text-gray-500">OR</span><span class="flex-grow border-t border-light-border dark:border-dark-border"></span></div>
                        
                        <div>
                            <label class="text-base font-semibold mb-2 block">Email</label>
                            <input id="login-email" type="email" placeholder="Enter your email" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                        <div>
                            <label class="text-base font-semibold mb-2 block">Password</label>
                            <input id="login-password" type="password" placeholder="Enter your password" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                        <button id="login-submit-btn" onclick="handleLogin()" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg text-lg transition-colors">Login</button>
                        <div id="login-status" class="text-center mt-4 text-sm h-4"></div>
                    </div>
                    
                    <!-- Signup Form -->
                    <div id="signup-form-container" class="space-y-4 hidden">
                         <button onclick="handleGoogleAuth()" class="w-full flex items-center justify-center space-x-3 bg-white dark:bg-gray-800 border border-light-border dark:border-dark-border rounded-lg py-3 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            <img src="https://www.vectorlogo.zone/logos/google/google-icon.svg" class="w-6 h-6" alt="Google Icon">
                            <span>Continue with Google</span>
                        </button>
                        <div class="flex items-center text-center"><span class="flex-grow border-t border-light-border dark:border-dark-border"></span><span class="px-3 text-sm text-gray-500">OR</span><span class="flex-grow border-t border-light-border dark:border-dark-border"></span></div>

                        <div>
                            <label class="text-base font-semibold mb-2 block">Username</label>
                            <input id="signup-username" type="text" placeholder="Choose a username" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                         <div>
                            <label class="text-base font-semibold mb-2 block">Email</label>
                            <input id="signup-email" type="email" placeholder="Enter your email" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                        <div>
                            <label class="text-base font-semibold mb-2 block">Phone Number</label>
                            <input id="signup-number" type="tel" placeholder="Enter your phone number" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                        <div>
                            <label class="text-base font-semibold mb-2 block">Password</label>
                            <input id="signup-password" type="password" placeholder="Create a password" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                        <!-- NEW: Referral Code Input -->
                        <div>
                            <label class="text-base font-semibold mb-2 block">Referral Code (Optional)</label>
                            <input id="signup-referral-code" type="text" placeholder="Enter referral code" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                        <button id="signup-submit-btn" onclick="handleSignup()" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg text-lg transition-colors mt-2">Sign Up</button>
                        <div id="signup-status" class="text-center mt-4 text-sm h-4"></div>
                    </div>
                </div>
            </main>
        </div>


        <!-- SCREEN: Product Detail -->
        <div id="product-detail-screen" class="app-screen bg-light-bg dark:bg-black no-flex">
             <main class="main-content no-scrollbar">
                <header class="p-4 flex items-center justify-between sticky top-0 bg-light-surface/80 dark:bg-black/80 backdrop-blur-sm z-20">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i><h1 class="text-xl font-bold text-accent">Reoffy Pakistan</h1>
                </header>
                <div class="pb-24">
                    <div id="product-image-slider" class="relative bg-black h-72">
                        <!-- Slider will be injected here by JS -->
                    </div>
                    <div id="product-detail-thumbnails" class="p-2 bg-light-surface dark:bg-dark-surface overflow-x-auto no-scrollbar" style="display: none;">
                        <div class="flex space-x-2">
                            <!-- Thumbnails will be injected here by JS -->
                        </div>
                    </div>
                    <div class="p-4 space-y-5">
                        <div class="flex justify-between items-start">
                            <div>
                                <p id="product-detail-price" class="text-3xl font-extrabold text-gray-900 dark:text-white"></p>
                                <h2 id="product-detail-title" class="text-xl font-bold mt-1 text-gray-800 dark:text-gray-200"></h2>
                            </div>
                            <div class="flex space-x-4 text-2xl mt-1 text-gray-500 dark:text-gray-400">
                                <i id="product-detail-like-icon" class="bi bi-heart cursor-pointer" onclick="toggleLike(event, currentViewingAd.id)"></i>
                                <i class="bi bi-share-fill cursor-pointer" onclick="shareProduct()"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                             <div class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
                                <i class="bi bi-geo-alt"></i>
                                <span id="product-detail-location"></span>
                            </div>
                             <div class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
                                <i class="bi bi-eye"></i>
                                <span id="product-detail-visitors">0 Visitors</span>
                            </div>
                            <span id="product-detail-time" class="text-gray-500"></span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-3">Details</h3>
                            <div id="product-details-table" class="bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg">
                                <!-- Details like brand, condition will be injected here -->
                            </div>
                        </div>
                        
                        <!-- Event Banner Placeholder -->
                        <div id="product-detail-event-banner-placeholder" class="mt-5 hidden"></div>

                        <div>
                            <h3 class="text-lg font-bold mb-2">Description</h3>
                            <p id="product-detail-description" class="text-gray-700 dark:text-gray-300 leading-relaxed space-y-1 whitespace-pre-wrap"></p>
                        </div>
                        
                        <!-- NEW SELLER INFO BLOCK -->
                        <div id="seller-info" class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg cursor-pointer border border-light-border dark:border-dark-border" onclick="viewPublicProfile(currentViewingAd.uid)">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-3">
                                    <img id="seller-info-avatar" src="" class="w-12 h-12 rounded-full object-cover" alt="Seller">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Posted by</p>
                                        <div class="flex items-center">
                                            <p class="font-bold text-lg" id="seller-info-name"></p>
                                            <!-- Verified badge will be injected here -->
                                        </div>
                                    </div>
                                </div>
                                <i class="bi bi-chevron-right text-gray-500 text-2xl"></i>
                            </div>
                            <hr class="my-3 border-light-border dark:border-dark-border">
                            <div class="flex justify-around text-center">
                                <div>
                                    <i class="bi bi-calendar-check-fill text-xl text-gray-500"></i>
                                    <p class="font-semibold text-sm" id="seller-member-since"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Member Since</p>
                                </div>
                                <div>
                                    <i class="bi bi-file-earmark-text-fill text-xl text-gray-500"></i>
                                    <p class="font-semibold text-sm" id="seller-active-ads"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Active Ads</p>
                                </div>
                            </div>
                        </div>

                         <!-- Seller Payment Info Block -->
                        <div id="seller-payment-info" class="hidden">
                            <h3 class="text-lg font-bold mb-2">Payment Details</h3>
                            <div id="seller-payment-details-container" class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg border border-light-border dark:border-dark-border space-y-4">
                                <!-- Payment details will be injected here -->
                            </div>
                        </div>

                        <div class="text-center">
                            <a href="#" class="text-sm text-gray-600 dark:text-gray-400 hover:underline flex items-center justify-center space-x-2">
                                <i class="bi bi-flag"></i>
                                <span>Report this ad</span>
                            </a>
                        </div>
                    </div>

                    <!-- Related Ads Section -->
                    <div id="related-ads-section" class="mt-6" style="display: none;">
                        <div class="flex justify-between items-center px-4 mb-3">
                            <h3 class="text-lg font-bold">You might also like</h3>
                            <span class="text-sm font-semibold text-accent cursor-pointer" onclick="navigateTo('featured-ads-list-screen')">See All</span>
                        </div>
                        <div class="overflow-x-auto no-scrollbar">
                            <div id="related-ads-container" class="flex space-x-3 px-4">
                                <!-- Related ad cards will be injected here -->
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>


        <!-- SCREEN: Public Profile -->
        <div id="public-profile-screen" class="app-screen no-flex">
             <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i><h1 class="text-xl font-bold">Seller Profile</h1>
                </header>
                <div class="p-4 space-y-6">
                    <div class="flex items-center space-x-4">
                        <div class="relative group">
                            <img id="public-profile-avatar" src="https://i.pravatar.cc/150" class="w-20 h-20 rounded-full bg-yellow-400 p-1 object-cover" alt="Seller">
                            <input type="file" id="profile-picture-upload" class="hidden" accept="image/*" onchange="handleProfilePictureChange(event)">
                            <div id="profile-upload-icon" onclick="document.getElementById('profile-picture-upload').click()" class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center text-white text-2xl cursor-pointer opacity-0 group-hover:opacity-100" style="display: none;">
                                <i class="bi bi-pencil-fill"></i>
                            </div>
                        </div>
                         <div>
                            <div class="flex items-center">
                                <h2 id="public-profile-name" class="text-2xl font-bold"></h2>
                                <span id="verified-seller-badge" class="hidden items-center bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-sm font-semibold px-2.5 py-1 rounded-full ml-3"><i class="bi bi-patch-check-fill mr-1.5"></i>Verified</span>
                            </div>
                            <p id="public-profile-member-since" class="text-sm text-gray-500 dark:text-gray-400 mt-1"></p>
                         </div>
                    </div>
                    <!-- Seller Credits -->
                     <div class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-2">Seller's Credits</h3>
                        <div class="flex justify-around text-center">
                            <div>
                                <p id="public-profile-ad-credits" class="text-2xl font-extrabold text-accent">0</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Monthly Ads Left</p>
                            </div>
                            <div>
                                <p id="public-profile-boost-credits" class="text-2xl font-extrabold text-yellow-500">0</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Boosts Left</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 id="public-profile-ads-heading" class="text-lg font-semibold mb-3">Active Ads</h3>
                        <div id="public-profile-ads-grid" class="grid grid-cols-2 gap-3">
                           <!-- Seller's ads will be loaded here from Firebase -->
                        </div>
                         <div id="public-profile-empty-state" class="hidden flex-col items-center justify-center text-center p-8">
                            <i class="bi bi-file-earmark-post-fill text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                            <h2 class="text-xl font-bold">No active ads.</h2>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">This seller has not listed any products yet.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- SCREEN: Plans -->
        <div id="plans-screen" class="app-screen no-flex">
             <main class="main-content no-scrollbar pb-24">
                 <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border"><i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i><h1 class="text-xl font-bold">Buy a Package</h1></header>
                <div id="plans-container" class="p-4 space-y-4">
                    <!-- Plans from Admin Panel will be loaded here -->
                </div>
            </main>
        </div>

        <!-- SCREEN: Payment -->
        <div id="payment-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Complete Payment</h1>
                </header>
                <div class="p-4 space-y-6">
                    <div>
                        <h3 class="text-base font-semibold mb-3">1. Select Payment Method</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div id="easypaisa-tab" class="payment-tab active border-2 rounded-lg p-4 text-center cursor-pointer" onclick="selectPaymentMethod('easypaisa')"><img src="https://download.logo.wine/logo/Easypaisa/Easypaisa-Logo.wine.png" class="h-8 mx-auto" alt="Easypaisa"></div>
                            <div id="jazzcash-tab" class="payment-tab border-2 rounded-lg p-4 text-center cursor-pointer" onclick="selectPaymentMethod('jazzcash')"><img src="https://phoneworld.com.pk/wp-content/uploads/2022/03/Jazz-Cash-Logo.png" class="h-8 mx-auto" alt="Jazzcash"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-base font-semibold mb-3">2. Send <span id="payment-amount-text" class="text-accent"></span> to this account</h3>
                        <div id="payment-details-easypaisa" class="bg-light-surface dark:bg-dark-surface rounded-lg p-4 space-y-3">
                            <div class="flex justify-between items-center"><span class="text-gray-500">Account Title:</span><span class="font-semibold">Reoffy Pakistan</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-500">Account Number:</span><div class="flex items-center space-x-2"><span id="easypaisa-acc" class="font-semibold">03139071038</span><i class="bi bi-clipboard-check-fill text-accent cursor-pointer" onclick="copyToClipboard('easypaisa-acc')"></i></div></div>
                        </div>
                         <div id="payment-details-jazzcash" class="bg-light-surface dark:bg-dark-surface rounded-lg p-4 space-y-3 hidden">
                            <div class="flex justify-between items-center"><span class="text-gray-500">Account Title:</span><span class="font-semibold">Reoffy Online</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-500">Account Number:</span><div class="flex items-center space-x-2"><span id="jazzcash-acc" class="font-semibold">03019022815</span><i class="bi bi-clipboard-check-fill text-accent cursor-pointer" onclick="copyToClipboard('jazzcash-acc')"></i></div></div>
                        </div>
                    </div>
                     <div>
                        <h3 class="text-base font-semibold mb-3">3. Submit your payment details</h3>
                        <div class="space-y-4">
                            <input id="transaction-id-input" type="text" placeholder="Enter Transaction ID (TID)" class="w-full bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent">
                            <div>
                                <input type="file" id="screenshot-input" class="hidden" accept="image/*" onchange="updateScreenshotName()">
                                <button onclick="document.getElementById('screenshot-input').click()" class="w-full flex justify-between items-center bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                    <span id="screenshot-label">Upload Screenshot</span>
                                    <i class="bi bi-upload"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sticky bottom-0 p-4 bg-light-surface/80 dark:bg-black/80 backdrop-blur-sm border-t border-light-border dark:border-dark-border">
                    <button id="submit-review-btn" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg text-lg transition-colors" onclick="submitForReview()">Submit for Review</button>
                </div>
            </main>
        </div>
        
        <!-- SCREEN: Transaction History -->
        <div id="transaction-history-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar pb-24">
                 <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Transaction History</h1>
                </header>
                <div id="transaction-list" class="p-4 space-y-3"></div>
                <div id="transaction-empty-state" class="hidden flex-col items-center justify-center h-[70vh] text-center p-8">
                    <i class="bi bi-receipt text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h2 class="text-xl font-bold">No transactions yet.</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Your payment history will appear here.</p>
                </div>
            </main>
        </div>

        <!-- SCREEN: Pending Approval -->
        <div id="pending-approval-screen" class="app-screen no-flex">
             <main class="main-content no-scrollbar pb-24">
                 <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Status</h1>
                </header>
                <div class="flex flex-col items-center justify-center h-[70vh] text-center p-8">
                    <i class="bi bi-clock-history text-6xl text-yellow-500 mb-4"></i>
                    <h2 class="text-2xl font-bold">Request Submitted</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-2 max-w-sm">Your payment is being reviewed. Your plan will be activated within 24 hours after approval. Thank you for your patience.</p>
                    <button class="mt-8 bg-accent text-white font-bold py-3 px-8 rounded-lg" onclick="navigateTo('home-screen')">Go to Home</button>
                </div>
            </main>
        </div>

         <!-- SCREEN: Mailbox -->
        <div id="mailbox-screen" class="app-screen no-flex">
            <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Mailbox</h1>
                </header>
                <div id="mailbox-list" class="divide-y divide-light-border dark:divide-dark-border"></div>
                <div id="mailbox-empty-state" class="hidden flex-col items-center justify-center h-[70vh] text-center p-8">
                    <i class="bi bi-envelope-open-fill text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h2 class="text-xl font-bold">No messages yet.</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Announcements from us will appear here.</p>
                </div>
            </main>
        </div>
        
        <!-- SCREEN: Privacy Policy -->
        <div id="privacy-policy-screen" class="app-screen no-flex">
             <main class="main-content no-scrollbar pb-24">
                <header class="p-4 flex items-center space-x-4 sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border">
                    <i class="bi bi-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
                    <h1 class="text-xl font-bold">Privacy Policy</h1>
                </header>
                <div class="p-6 prose dark:prose-invert">
                    <h2>Privacy Policy for Reoffy Pakistan</h2>
                    <p><strong>Last updated:</strong> September 27, 2025</p>
                    <p>This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service and tells You about Your privacy rights and how the law protects You.</p>
                    <p>We use Your Personal data to provide and improve the Service. By using the Service, You agree to the collection and use of information in accordance with this Privacy Policy.</p>
                    
                    <h3>Collecting and Using Your Personal Data</h3>
                    <h4>Types of Data Collected</h4>
                    <p><strong>Personal Data:</strong> While using Our Service, We may ask You to provide Us with certain personally identifiable information that can be used to contact or identify You. Personally identifiable information may include, but is not limited to: Email address, Username, Phone number.</p>
                    <p><strong>Usage Data:</strong> Usage Data is collected automatically when using the Service. This may include information such as Your Device's Internet Protocol address (e.g. IP address), browser type, browser version, the pages of our Service that You visit, the time and date of Your visit, the time spent on those pages, unique device identifiers and other diagnostic data.</p>
                    
                     <h3>Contact Us</h3>
                    <p>If you have any questions about this Privacy Policy, You can contact us through the Help Center.</p>
                </div>
            </main>
        </div>

    </div>

    <!-- FOOTER & MODALS -->
    <div id="product-detail-footer" style="display: none;" class="fixed bottom-0 left-0 right-0 p-2 bg-light-surface dark:bg-black border-t border-light-border dark:border-dark-border z-30">
         <div class="max-w-md mx-auto grid grid-cols-2 gap-3">
            <button id="whatsapp-order-btn" onclick="orderOnWhatsApp()" class="flex items-center justify-center border-2 border-accent text-accent p-3 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed"><i class="bi bi-whatsapp mr-2"></i> Order on WhatsApp</button>
            <button class="flex items-center justify-center bg-accent text-white p-3 rounded-lg font-bold" onclick="startChat()"><i class="bi bi-chat-dots-fill mr-2"></i> Chat</button>
        </div>
    </div>
    
    <nav id="main-nav" class="fixed bottom-0 left-0 right-0 h-20 bg-light-surface dark:bg-dark-surface border-t border-light-border dark:border-dark-border flex justify-around items-center pt-2 z-40">
        <a href="#" class="nav-item text-center text-accent w-1/5" data-target="home-screen"><i class="bi bi-house-fill text-2xl"></i><span class="text-xs block font-medium">Home</span></a>
        <a href="#" class="nav-item text-center text-gray-500 dark:text-gray-400 w-1/5" data-target="chats-screen"><i class="bi bi-chat-dots-fill text-2xl"></i><span class="text-xs block">Chats</span></a>
        <div class="w-1/5"></div>
        <a href="#" class="nav-item text-center text-gray-500 dark:text-gray-400 w-1/5" data-target="my-ads-screen"><i class="bi bi-file-earmark-text-fill text-2xl"></i><span class="text-xs block">My Ads</span></a>
        <a href="#" class="nav-item text-center text-gray-500 dark:text-gray-400 w-1/5 relative" data-target="account-screen">
            <i class="bi bi-person-fill text-2xl"></i>
            <span class="text-xs block">Account</span>
            <span id="account-nav-dot" class="absolute top-1 right-5 w-2 h-2 bg-red-500 rounded-full hidden"></span>
        </a>
    </nav>
    
    <div id="nav-sell-button"><a href="#" class="nav-item" data-target="sell-screen"><i class="bi bi-plus-lg"></i></a></div>
    
    <!-- MODAL: City Selection -->
    <div id="city-selection-screen" class="modal fixed inset-0 bg-black/50 z-[101] hidden" onclick="closeModal('city-selection-screen')">
        <div id="city-selection-modal-content" class="absolute bottom-0 left-0 right-0 h-[80vh] bg-light-bg dark:bg-dark-bg rounded-t-2xl p-4 flex flex-col transform translate-y-full transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Select City</h2>
                <i class="bi bi-x-lg text-2xl cursor-pointer" onclick="closeModal('city-selection-screen')"></i>
            </div>
            <input type="text" id="city-search-input" placeholder="Search for a city..." class="w-full p-3 rounded-lg bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border mb-4" onkeyup="filterList('city-search-input', 'city-list-container')">
            <div class="overflow-y-auto no-scrollbar">
                <ul id="city-list-container" class="divide-y divide-light-border dark:divide-dark-border">
                </ul>
            </div>
        </div>
    </div>

    <!-- MODAL: Brand Selection -->
    <div id="brand-selection-screen" class="modal fixed inset-0 bg-black/50 z-[101] hidden" onclick="closeModal('brand-selection-screen')">
        <div id="brand-selection-modal-content" class="absolute bottom-0 left-0 right-0 h-[80vh] bg-light-bg dark:bg-dark-bg rounded-t-2xl p-4 flex flex-col transform translate-y-full transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Select Brand</h2>
                <i class="bi bi-x-lg text-2xl cursor-pointer" onclick="closeModal('brand-selection-screen')"></i>
            </div>
            <input type="text" id="brand-search-input" placeholder="Search for a brand..." class="w-full p-3 rounded-lg bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border mb-4" onkeyup="filterList('brand-search-input', 'brand-list-container')">
            <div class="overflow-y-auto no-scrollbar">
                <ul id="brand-list-container" class="divide-y divide-light-border dark:divide-dark-border">
                </ul>
            </div>
        </div>
    </div>
    
    <!-- MODAL: Advanced Filters -->
    <div id="advanced-filters-modal" class="modal fixed inset-0 bg-black/50 z-[101] hidden" onclick="closeModal('advanced-filters-modal')">
        <div id="advanced-filters-modal-content" class="absolute bottom-0 left-0 right-0 bg-light-bg dark:bg-dark-bg rounded-t-2xl p-4 flex flex-col transform translate-y-full transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Filters</h2>
                <i class="bi bi-x-lg text-2xl cursor-pointer" onclick="closeModal('advanced-filters-modal')"></i>
            </div>
            <div class="space-y-4 p-2">
                <h3 class="font-semibold text-lg">Price Range (Rs)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="min-price" class="text-sm">Minimum</label>
                        <input type="number" id="min-price" placeholder="e.g., 5000" class="w-full mt-1 p-2 rounded-lg bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border">
                    </div>
                    <div>
                        <label for="max-price" class="text-sm">Maximum</label>
                        <input type="number" id="max-price" placeholder="e.g., 50000" class="w-full mt-1 p-2 rounded-lg bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border">
                    </div>
                </div>
            </div>
            <div class="mt-auto p-2 grid grid-cols-2 gap-3">
                <button onclick="clearAllFilters()" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-bold py-3 rounded-lg transition-colors">Clear</button>
                <button onclick="applyAllFilters()" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg transition-colors">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Mailbox Message Detail -->
    <div id="mailbox-detail-modal" class="modal fixed inset-0 bg-black/50 z-[101] hidden" onclick="closeModal('mailbox-detail-modal')">
        <div id="mailbox-detail-modal-content" class="absolute bottom-0 left-0 right-0 max-h-[90vh] bg-light-bg dark:bg-dark-bg rounded-t-2xl flex flex-col transform translate-y-full transition-transform duration-300" onclick="event.stopPropagation()">
             <div class="flex justify-between items-center p-4 bg-accent text-white">
                <div class="flex items-center space-x-3">
                    <img src="https://www.vectorlogo.zone/logos/google/google-icon.svg" class="w-8 h-8 rounded-full bg-white p-1" alt="App Icon">
                    <div>
                        <h2 id="mailbox-detail-title" class="text-lg font-bold">Message</h2>
                        <p class="text-xs opacity-80">Reoffy Pakistan</p>
                    </div>
                </div>
                <i class="bi bi-x-lg text-2xl cursor-pointer" onclick="closeModal('mailbox-detail-modal')"></i>
            </div>
            <div class="overflow-y-auto no-scrollbar p-4 space-y-4">
                <img id="mailbox-detail-image" src="" class="w-full h-48 object-cover rounded-lg hidden" alt="Announcement Image">
                <p id="mailbox-detail-body" class="text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap"></p>
                <a id="mailbox-detail-link" href="#" target="_blank" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg transition-colors text-center hidden">
                    Learn More
                </a>
            </div>
        </div>
    </div>
    
    <!-- MODAL: Boost Options -->
    <div id="boost-options-modal" class="modal fixed inset-0 bg-black/50 z-[101] hidden" onclick="closeModal('boost-options-modal')">
        <div id="boost-options-modal-content" class="absolute bottom-0 left-0 right-0 bg-light-bg dark:bg-dark-bg rounded-t-2xl p-4 flex flex-col transform translate-y-full transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Boost Your Ad</h2>
                <i class="bi bi-x-lg text-2xl cursor-pointer" onclick="closeModal('boost-options-modal')"></i>
            </div>
            <div class="space-y-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">Choose a duration to feature your ad at the top of the listings. Your current boost credits: <span id="boost-credits-count" class="font-bold text-yellow-500">0</span></p>
                <button onclick="confirmBoost(3, 3)" class="w-full text-left p-4 bg-light-surface dark:bg-dark-surface rounded-lg border dark:border-dark-border hover:border-accent">
                    <p class="font-bold text-lg">3 Days Boost</p>
                    <p class="text-sm text-yellow-500 font-semibold">Cost: 3 Boost Credits</p>
                </button>
                <button onclick="confirmBoost(6, 6)" class="w-full text-left p-4 bg-light-surface dark:bg-dark-surface rounded-lg border dark:border-dark-border hover:border-accent">
                    <p class="font-bold text-lg">6 Days Boost</p>
                    <p class="text-sm text-yellow-500 font-semibold">Cost: 6 Boost Credits</p>
                </button>
                <button onclick="confirmBoost(9, 9)" class="w-full text-left p-4 bg-light-surface dark:bg-dark-surface rounded-lg border dark:border-dark-border hover:border-accent">
                    <p class="font-bold text-lg">9 Days Boost</p>
                    <p class="text-sm text-yellow-500 font-semibold">Cost: 9 Boost Credits</p>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: Help Center -->
    <div id="help-center-modal" class="modal fixed inset-0 bg-black/50 z-[101] hidden" onclick="closeModal('help-center-modal')">
        <div id="help-center-modal-content" class="absolute bottom-0 left-0 right-0 bg-light-bg dark:bg-dark-bg rounded-t-2xl p-4 flex flex-col transform translate-y-full transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Help Center</h2>
                <i class="bi bi-x-lg text-2xl cursor-pointer" onclick="closeModal('help-center-modal')"></i>
            </div>
            <div id="help-center-links" class="space-y-3">
                <!-- Links will be populated here -->
                <p class="text-center text-gray-500">Loading support options...</p>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getDatabase, ref, set, push, get, child, onValue, remove, update, query, orderByChild, equalTo, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyCM0uOmXMVHAxuDjA86SQjTVgBs-yDjb8g",
        authDomain: "frampakistan.firebaseapp.com",
        databaseURL: "https://frampakistan-default-rtdb.firebaseio.com",
        projectId: "frampakistan",
        storageBucket: "frampakistan.appspot.com",
        messagingSenderId: "101915821158",
        appId: "1:101915821158:web:35b8f9d896707c2c6259a7",
        measurementId: "G-D9GQCDGBT4"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      window.firebase = { auth, db, ref, set, push, get, child, onValue, remove, update, query, orderByChild, equalTo, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, increment, GoogleAuthProvider, signInWithPopup };
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.firebase) {
                console.error("Firebase is not initialized!");
                return;
            }

            const { auth, db, ref, set, push, get, child, onValue, remove, update, query, orderByChild, equalTo, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, increment, GoogleAuthProvider, signInWithPopup } = window.firebase;

            // --- PWA INSTALLATION LOGIC ---
            let deferredPrompt;
            const installPwaBanner = document.getElementById('pwa-install-banner');
            const installAppBtn = document.getElementById('install-app-btn');
            const closeInstallBannerBtn = document.getElementById('close-install-banner-btn');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (installPwaBanner && !window.matchMedia('(display-mode: standalone)').matches) {
                    installPwaBanner.classList.remove('hidden');
                }
            });

            if (installAppBtn) {
                installAppBtn.addEventListener('click', async () => {
                    if (installPwaBanner) installPwaBanner.classList.add('hidden');
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response to the install prompt: ${outcome}`);
                        deferredPrompt = null;
                    }
                });
            }
            if(closeInstallBannerBtn) {
                closeInstallBannerBtn.addEventListener('click', () => {
                    if (installPwaBanner) installPwaBanner.classList.add('hidden');
                });
            }

            window.addEventListener('appinstalled', () => {
                if (installPwaBanner) installPwaBanner.classList.add('hidden');
                deferredPrompt = null;
                console.log('PWA was installed');
            });


            // --- STATE MANAGEMENT & CONSTANTS ---
            const IMGBB_API_KEY = 'db801e55f83a34710dc37d103f1048a8';
            const allScreens = document.querySelectorAll('.app-screen');
            const historyStack = []; 
            let allAdsData = [];
            let currentFilters = { category: 'All', location: 'All Pakistan', brand: 'All Brands', minPrice: null, maxPrice: null, searchTerm: '' };
            let currentEditingAd = null; 
            let currentViewingAd = null; 
            let currentBoostingAdId = null;
            let currentChatKey = null; 
            let chatListener = null; 
            let uploadedImageUrls = []; 
            let currentLocationTargetId = null; 
            let screenshotFile = null;
            let currentPurchaseDetails = { planId: null, planName: null, price: 0 };
            let toastTimeout;
            const boostIntervals = {};
            let eventBannerData = null;

            // --- AUTHENTICATION STATE ---
            let currentUser = null; 
            let currentUserProfile = null;
            let nextScreenAfterLogin = null; 
            
            // --- CUSTOM TOAST NOTIFICATION ---
            window.showToast = (message, type = 'success', duration = 3000) => {
                const toast = document.getElementById('toast-notification');
                if (!toast) return;
                clearTimeout(toastTimeout);
                toast.textContent = message;
                toast.className = 'show';
                toast.classList.add(type);
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            };

            // --- FIREBASE AUTH LISTENER ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    const userRef = ref(db, 'users/' + user.uid);
                    onValue(userRef, (snapshot) => {
                        if (snapshot.exists()) {
                            currentUserProfile = snapshot.val();
                            if (currentUserProfile.status === 'suspended') {
                                showToast('Your account has been suspended.', 'error');
                                signOut(auth);
                                return;
                            }
                        }
                        
                        if (historyStack[historyStack.length - 1] === 'account-screen') updateAccountScreenView();
                        if (historyStack[historyStack.length - 1] === 'settings-screen') renderSettingsScreen();
                        if (historyStack[historyStack.length - 1] === 'sell-screen') populateSellFormUserInfo();
                        fetchAllAds(); 
                        checkForNewMail();
                        if (nextScreenAfterLogin) {
                            navigateTo(nextScreenAfterLogin.screenId, false, nextScreenAfterLogin.params);
                            nextScreenAfterLogin = null; 
                        } else if (historyStack.includes('auth-screen')) {
                            navigateTo('home-screen');
                        }
                    }, { onlyOnce: false });
                } else {
                    currentUser = null;
                    currentUserProfile = null;
                    const authRequiredScreens = ['sell-screen', 'chats-screen', 'my-ads-screen', 'account-screen', 'edit-ad-screen', 'settings-screen', 'chat-detail-screen', 'plans-screen', 'payment-screen', 'favorites-screen', 'mailbox-screen', 'transaction-history-screen', 'privacy-policy-screen', 'featured-ads-list-screen', 'fresh-ads-list-screen', 'invite-screen'];
                    if (authRequiredScreens.includes(historyStack[historyStack.length - 1])) {
                        navigateTo('home-screen');
                    }
                    fetchAllAds(); 
                    updateAccountScreenView(); 
                    updateNotificationDots(false);
                }
            });
            
            // --- SELL FORM UTILITY ---
             function populateSellFormUserInfo() {
                if (currentUserProfile) {
                    document.getElementById('sell-contact-name').value = currentUserProfile.username || '';
                    document.getElementById('sell-contact-phone').value = currentUserProfile.phone || '';
                }
            }
            function resetSellForm() {
                document.getElementById('sell-title').value = ''; document.getElementById('sell-description').value = '';
                document.getElementById('sell-price').value = ''; document.getElementById('sell-category').selectedIndex = 0;
                document.getElementById('sell-brand-model').value = ''; document.getElementById('sell-condition').selectedIndex = 0;
                document.getElementById('sell-location-text').textContent = 'Select Location';
                document.getElementById('sell-location-text').classList.add('text-gray-500', 'dark:text-gray-400');
                document.getElementById('image-preview-container').innerHTML = ''; document.getElementById('sell-show-payment').checked = false;
                uploadedImageUrls = []; populateSellFormUserInfo();
            }

            // --- THEME & NAVIGATION ---
            document.getElementById('theme-toggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark');});
            
            window.navigateTo = (screenId, isBack = false, params = null) => {
                const authRequiredScreens = ['sell-screen', 'chats-screen', 'my-ads-screen', 'account-screen', 'edit-ad-screen', 'settings-screen', 'chat-detail-screen', 'plans-screen', 'payment-screen', 'favorites-screen', 'mailbox-screen', 'transaction-history-screen', 'privacy-policy-screen', 'featured-ads-list-screen', 'fresh-ads-list-screen', 'invite-screen'];
                if (authRequiredScreens.includes(screenId) && !currentUser) { 
                    nextScreenAfterLogin = { screenId, params }; navigateTo('auth-screen'); return; 
                }
                
                if (screenId === 'sell-screen') resetSellForm();
                if (screenId === 'plans-screen') renderPlans();
                if (screenId === 'featured-ads-list-screen') renderFeaturedAdsList();
                if (screenId === 'fresh-ads-list-screen') renderFreshAdsList();

                if (screenId === 'payment-screen' && params) {
                    currentPurchaseDetails = { ...params };
                    document.getElementById('payment-amount-text').textContent = `Rs ${params.price}`;
                }
                
                if (chatListener && screenId !== 'chat-detail-screen') { chatListener(); chatListener = null; }
                
                if (!isBack && historyStack[historyStack.length - 1] !== screenId) {
                    historyStack.push(screenId);
                    history.pushState({ screen: screenId }, ``, `#${screenId}`);
                }

                allScreens.forEach(s => s.classList.remove('active'));
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) targetScreen.classList.add('active');
                if(targetScreen.querySelector('.main-content')) targetScreen.querySelector('.main-content').scrollTop = 0;
                
                const specialScreens = ['product-detail-screen', 'sell-screen', 'edit-ad-screen', 'public-profile-screen', 'chat-detail-screen', 'payment-screen', 'pending-approval-screen', 'plans-screen', 'transaction-history-screen', 'auth-screen', 'settings-screen', 'favorites-screen', 'mailbox-screen', 'privacy-policy-screen', 'featured-ads-list-screen', 'fresh-ads-list-screen', 'invite-screen'];
                const hideNav = specialScreens.includes(screenId);
                document.getElementById('main-nav').style.display = hideNav ? 'none' : 'flex';
                document.getElementById('nav-sell-button').style.display = hideNav ? 'none' : 'block';
                document.getElementById('product-detail-footer').style.display = screenId === 'product-detail-screen' ? 'block' : 'none';
                
                const navItems = document.querySelectorAll('#main-nav .nav-item');
                navItems.forEach(item => {
                    item.classList.remove('text-accent'); item.classList.add('text-gray-500', 'dark:text-gray-400');
                    item.querySelector('span').classList.remove('font-medium');
                });
                const activeNavItem = document.querySelector(`#main-nav .nav-item[data-target="${screenId}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('text-accent'); activeNavItem.classList.remove('text-gray-500', 'dark:text-gray-400');
                    activeNavItem.querySelector('span').classList.add('font-medium');
                }

                if (screenId === 'account-screen') updateAccountScreenView();
                if (screenId === 'my-ads-screen') { renderMyAds(); switchMyAdsTab('active'); }
                if (screenId === 'chats-screen') renderChatList();
                if (screenId === 'settings-screen') renderSettingsScreen();
                if (screenId === 'favorites-screen') renderFavorites();
                if (screenId === 'transaction-history-screen') renderTransactionHistory();
                if (screenId === 'invite-screen') renderInviteScreen();
                if (screenId === 'mailbox-screen') { 
                    renderMailbox(); localStorage.setItem('lastMailTimestamp', Date.now());
                    updateNotificationDots(false);
                }
            };
            
            window.goBack = () => { if (historyStack.length > 1) { history.back(); }};
            
            window.addEventListener('popstate', (event) => {
                if (historyStack.length > 1) {
                     historyStack.pop();
                     navigateTo(historyStack[historyStack.length - 1], true);
                }
            });

            // --- MODAL CONTROLS ---
            window.openModal = (modalId, targetId = null) => {
                if (modalId === 'help-center-modal') openHelpCenter();
                if (targetId) currentLocationTargetId = targetId;
                const modal = document.getElementById(modalId);
                const modalContent = modal.querySelector('div[id$="-content"]');
                modal.classList.remove('hidden');
                setTimeout(() => { modalContent.classList.remove('translate-y-full'); }, 10);
            };
            window.closeModal = (modalId) => {
                const modal = document.getElementById(modalId);
                const modalContent = modal.querySelector('div[id$="-content"]');
                modalContent.classList.add('translate-y-full');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            };

            // --- DYNAMIC DATA & DEFAULTS ---
            const defaultCategories = [
                { name: 'Mobiles', icon: 'bi-phone-fill' }, { name: 'Vehicles', icon: 'bi-car-front-fill' },
                { name: 'Property', icon: 'bi-house-door-fill' }, { name: 'Electronics', icon: 'bi-pc-display-horizontal' },
                { name: 'Home Appliances', icon: 'bi-plug-fill' }, { name: 'Furniture', icon: 'bi-lamp-fill' },
                { name: 'Fashion', icon: 'bi-person-standing-dress' }, { name: 'Pets', icon: 'bi-bug-fill' },
                { name: 'Bikes', icon: 'bi-bicycle' }, { name: 'Services', icon: 'bi-tools' }
            ];
            async function fetchAndPopulateConfig() {
                const promotionsContainer = document.getElementById('home-promotions-container');
                promotionsContainer.innerHTML = '<div class="w-full h-full skeleton"></div>';

                const configRef = ref(db, 'config');
                const snapshot = await get(configRef);
                const config = snapshot.exists() ? snapshot.val() : {};

                if (config.promotions && config.promotions.length > 0) {
                    promotionsContainer.innerHTML = `<div class="slider-wrapper">${config.promotions.map(p => `<div class="slider-slide"><img src="${p.imageUrl}" class="w-full h-full object-cover" alt="Promotion"></div>`).join('')}</div>`;
                    if (config.promotions.length > 1) initSlider(promotionsContainer);
                } else {
                     promotionsContainer.innerHTML = `<img src="https://images.unsplash.com/photo-1616486338812-3dadae4b4ace?q=80&w=1000" class="w-full h-full object-cover" alt="Featured Promotion">`;
                }

                let finalCategories = [...defaultCategories];
                if (config.categories) {
                    const defaultNames = new Set(defaultCategories.map(c => c.name));
                    const adminCategories = config.categories.filter(c => !defaultNames.has(c.name));
                    finalCategories = [...finalCategories, ...adminCategories];
                }
                populateCategories(finalCategories);

                if (config.brands) {
                    document.getElementById('brands-datalist').innerHTML = config.brands.map(b => `<option value="${b}"></option>`).join('');
                }
                populateListFromConfig(config.brands, 'brand-list-container', 'selectBrand');
                populateListFromConfig(config.cities, 'city-list-container', 'selectCity');
            }
            function populateCategories(categories) {
                const container = document.getElementById('home-category-container');
                const sellSelect = document.getElementById('sell-category');
                const editSelect = document.getElementById('edit-category');
                container.innerHTML = `<div class="text-center flex-shrink-0 w-16 category-item active" onclick="applyCategoryFilter('All', this)"><div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center mx-auto mb-1"><i class="bi bi-grid-fill text-white text-2xl"></i></div><span class="text-xs font-medium text-gray-700 dark:text-gray-300">All</span></div>`;
                sellSelect.innerHTML = `<option disabled selected>Select a category</option>`; editSelect.innerHTML = '';
                categories.forEach(cat => {
                    const iconClass = cat.icon || 'bi-tag-fill';
                    container.innerHTML += `<div class="text-center flex-shrink-0 w-16 category-item" onclick="applyCategoryFilter('${cat.name}', this)"><div class="w-12 h-12 bg-light-surface dark:bg-dark-surface rounded-full flex items-center justify-center mx-auto mb-1"><i class="bi ${iconClass} text-accent text-2xl"></i></div><span class="text-xs text-gray-600 dark:text-gray-400">${cat.name}</span></div>`;
                    sellSelect.innerHTML += `<option>${cat.name}</option>`; editSelect.innerHTML += `<option>${cat.name}</option>`;
                });
            }
            function populateListFromConfig(items, containerId, selectFunction) {
                if (!items) return;
                const container = document.getElementById(containerId);
                const allOption = containerId.includes('city') ? 'All Pakistan' : 'All Brands';
                container.innerHTML = `<li class="p-3 cursor-pointer hover:bg-gray-200 dark:hover:bg-dark-surface dark:text-gray-200" onclick="${selectFunction}('${allOption}')">${allOption}</li>`;
                items.forEach(item => { container.innerHTML += `<li class="p-3 cursor-pointer hover:bg-gray-200 dark:hover:bg-dark-surface dark:text-gray-200" onclick="${selectFunction}('${item}')">${item}</li>`; });
            }
            
            // --- LOCATION SERVICES ---
            window.getCurrentLocation = (targetId) => {
                if (!navigator.geolocation) return showToast("Geolocation is not supported.", "error");
                const targetElement = document.getElementById(targetId); targetElement.textContent = "Fetching...";
                navigator.geolocation.getCurrentPosition(
                    (position) => { targetElement.textContent = `Near You`; targetElement.classList.remove('text-gray-500', 'dark:text-gray-400'); },
                    () => { targetElement.textContent = "Select Location"; showToast("Unable to retrieve location.", "error"); }
                );
            };
            
            window.selectCity = (cityName) => {
                if(currentLocationTargetId === 'home-location-filter-text') { currentFilters.location = cityName; renderFilteredAds(); }
                document.getElementById(currentLocationTargetId).textContent = cityName;
                document.getElementById(currentLocationTargetId).classList.remove('text-gray-500', 'dark:text-gray-400');
                closeModal('city-selection-screen');
            };
            window.selectBrand = (brandName) => {
                currentFilters.brand = brandName; document.getElementById('home-brand-filter-text').textContent = brandName;
                closeModal('brand-selection-screen'); renderFilteredAds();
            };
            window.filterList = (inputId, containerId) => {
                const filter = document.getElementById(inputId).value.toUpperCase(); const ul = document.getElementById(containerId);
                const li = ul.getElementsByTagName('li');
                for (let i = 0; i < li.length; i++) { li[i].style.display = li[i].textContent.toUpperCase().includes(filter) ? "" : "none"; }
            };

            // --- AUTHENTICATION & REFERRAL ---
            const showAuthStatus=(f,m,t='error')=>{const s=document.getElementById(`${f}-status`);s.textContent=m;s.className=t==='error'?'text-center mt-4 text-sm h-4 text-red-500':'text-center mt-4 text-sm h-4 text-green-500'};window.switchAuthForm=f=>{document.getElementById('login-form-container').classList.toggle('hidden',f!=='login');document.getElementById('signup-form-container').classList.toggle('hidden',f!=='signup');document.getElementById('auth-login-btn').classList.toggle('active',f==='login');document.getElementById('auth-signup-btn').classList.toggle('active',f==='signup')};window.handleLogin=async()=>{const e=document.getElementById('login-email').value.trim(),p=document.getElementById('login-password').value.trim(),b=document.getElementById('login-submit-btn');if(!e||!p){showAuthStatus('login','Please fill in all fields.');return}b.disabled=true;b.textContent='Logging in...';showAuthStatus('login','','success');try{await signInWithEmailAndPassword(auth,e,p)}catch(err){showAuthStatus('login',err.message)}finally{b.disabled=false;b.textContent='Login'}};
            
            async function applyReferralReward(referralCode) {
                if (!referralCode) return;
                const usersRef = ref(db, 'users');
                const referrerQuery = query(usersRef, orderByChild('referralCode'), equalTo(referralCode.toUpperCase()));
                const snapshot = await get(referrerQuery);

                if (snapshot.exists()) {
                    const referrerId = Object.keys(snapshot.val())[0];
                    const rewardsSnap = await get(ref(db, 'config/referralRewards'));
                    if (rewardsSnap.exists()) {
                        const rewards = rewardsSnap.val();
                        const updates = {};
                        if (rewards.adCredits > 0) updates.adCredits = increment(rewards.adCredits);
                        if (rewards.boostCredits > 0) updates.boostCredits = increment(rewards.boostCredits);
                        
                        if (Object.keys(updates).length > 0) {
                            await update(ref(db, `users/${referrerId}`), updates);
                             await push(ref(db, `users/${referrerId}/transactions`), { 
                                type: 'referral_reward', 
                                description: `Reward for referring a new user.`, 
                                details: `+${rewards.adCredits || 0} Ads, +${rewards.boostCredits || 0} Boosts`,
                                timestamp: Date.now() 
                            });
                        }
                    }
                }
            }

            // NEW: Google Authentication Handler
            window.handleGoogleAuth = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    
                    // Check if user exists in database
                    const userRef = ref(db, 'users/' + user.uid);
                    const snapshot = await get(userRef);

                    if (!snapshot.exists()) {
                        // This is a new user, create a profile for them
                        const freePlanSnap = await get(ref(db, 'config/freeUserPlan'));
                        const initialCredits = freePlanSnap.exists() ? freePlanSnap.val().initialAds : 4;
                        const referralCode = user.uid.substring(0, 8).toUpperCase();

                        await set(userRef, {
                            username: user.displayName,
                            email: user.email,
                            phone: user.phoneNumber || '',
                            uid: user.uid,
                            avatar: user.photoURL,
                            memberSince: new Date().toISOString(),
                            adCredits: initialCredits,
                            boostCredits: 0,
                            lastCreditReset: Date.now(),
                            status: 'active',
                            isVerified: false,
                            whatsAppUnlocked: false,
                            referralCode: referralCode
                        });
                        showToast('Welcome to Reoffy Pakistan!', 'success');
                    }
                    // If user exists, onAuthStateChanged will handle navigation
                } catch (error) {
                    console.error("Google Auth Error: ", error);
                    showToast('Google Sign-In failed. Please try again.', 'error');
                }
            };

            window.handleSignup = async () => {
                const u = document.getElementById('signup-username').value.trim(), e = document.getElementById('signup-email').value.trim(),
                    p = document.getElementById('signup-number').value.trim(), pw = document.getElementById('signup-password').value.trim(),
                    refCode = document.getElementById('signup-referral-code').value.trim(), b = document.getElementById('signup-submit-btn');
                if (!u || !e || !p || !pw) { showAuthStatus('signup', 'Please fill in all fields except referral code.'); return }
                
                b.disabled = true; b.textContent = 'Signing up...'; showAuthStatus('signup', '', 'success');
                try {
                    const s = await get(ref(db, 'config/freeUserPlan')), c = s.exists() ? s.val().initialAds : 4;
                    const uc = await createUserWithEmailAndPassword(auth, e, pw), user = uc.user, a = `https://i.pravatar.cc/150?u=${user.uid}`;
                    const referralCode = user.uid.substring(0, 8).toUpperCase();
                    await updateProfile(user, { displayName: u, photoURL: a });
                    
                    await set(ref(db, 'users/' + user.uid), {
                        username: u, email: e, phone: p, uid: user.uid, avatar: a, memberSince: new Date().toISOString(),
                        adCredits: c, boostCredits: 0, lastCreditReset: Date.now(), status: 'active', isVerified: false, whatsAppUnlocked: false, referralCode: referralCode
                    });

                    if (p) {
                        await set(ref(db, 'newUsersWithPhone/' + user.uid), {
                            uid: user.uid, username: u, phone: p, timestamp: Date.now(), status: 'pending'
                        });
                    }
                    
                    if(refCode) {
                       await applyReferralReward(refCode);
                    }

                } catch (err) { showAuthStatus('signup', err.message) 
                } finally { b.disabled = false; b.textContent = 'Sign Up' }
            };

            window.handleLogout=()=>{if(confirm('Are you sure you want to logout?'))signOut(auth).then(()=>navigateTo('home-screen')).catch(e=>showToast(e.message, 'error'))};

            // --- ACCOUNT & SETTINGS ---
            function updateAccountScreenView(){const c=document.getElementById('account-screen');if(currentUser&&currentUserProfile){let avatarHTML;if(currentUserProfile.isVerified){avatarHTML=`<div class="relative"><div class="p-1 rounded-full border-2 border-blue-500"><img src="${currentUserProfile.avatar}" alt="User" class="w-16 h-16 rounded-full object-cover"></div><div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 bg-blue-500 text-white rounded-full flex items-center justify-center w-6 h-6 border-2 border-light-surface dark:border-dark-bg"><i class="bi bi-patch-check-fill text-base"></i></div></div>`}else{avatarHTML=`<img src="${currentUserProfile.avatar}" alt="User" class="w-16 h-16 rounded-full object-cover">`}c.innerHTML=`<main class="main-content no-scrollbar pb-24 dark:bg-dark-bg"><header class="p-4 flex items-center justify-between sticky top-0 bg-light-surface/80 dark:bg-dark-bg/80 backdrop-blur-sm z-20 border-b border-light-border dark:border-dark-border"><h1 class="text-xl font-bold">My Account</h1></header><div class="p-4 flex items-center space-x-4">${avatarHTML}<div><h2 class="text-2xl font-bold">${currentUserProfile.username}</h2><p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${currentUserProfile.email}</p><p class="text-sm text-accent cursor-pointer mt-2" onclick="viewPublicProfile('${currentUser.uid}')">View public profile & Credits</p></div></div><div class="px-4 space-y-3"><div class="bg-gradient-to-r from-accent to-emerald-600 text-white p-4 rounded-lg cursor-pointer shadow-lg" onclick="navigateTo('plans-screen')"><h3 class="font-extrabold text-lg">Buy Discounted Packages</h3><p class="text-sm mt-1">Get More Ad Listings & Boosts!</p></div></div><div class="p-4 mt-2 space-y-1"><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="navigateTo('my-ads-screen')"><i class="bi bi-file-earmark-text-fill text-xl text-accent w-8"></i><p class="font-semibold ml-4">My Ads</p><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="navigateTo('favorites-screen')"><i class="bi bi-heart-fill text-xl text-accent w-8"></i><p class="font-semibold ml-4">Favorite Ads</p><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="navigateTo('invite-screen')"><i class="bi bi-people-fill text-xl text-accent w-8"></i><p class="font-semibold ml-4">Invite Friends</p><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="navigateTo('mailbox-screen')"><i class="bi bi-envelope-fill text-xl text-accent w-8"></i><p class="font-semibold ml-4">Mailbox</p><span id="mailbox-menu-dot" class="w-2 h-2 bg-red-500 rounded-full ml-2 hidden"></span><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="navigateTo('transaction-history-screen')"><i class="bi bi-receipt-cutoff text-xl text-accent w-8"></i><p class="font-semibold ml-4">Transaction History</p><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="openModal('help-center-modal')"><i class="bi bi-question-circle-fill text-xl text-accent w-8"></i><p class="font-semibold ml-4">Help Center</p><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="navigateTo('privacy-policy-screen')"><i class="bi bi-shield-lock-fill text-xl text-accent w-8"></i><p class="font-semibold ml-4">Privacy Policy</p><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="navigateTo('settings-screen')"><i class="bi bi-gear-fill text-xl text-accent w-8"></i><p class="font-semibold ml-4">Settings</p><i class="bi bi-chevron-right ml-auto"></i></div><div class="flex items-center p-3 hover:bg-gray-200 dark:hover:bg-dark-surface rounded-lg cursor-pointer" onclick="handleLogout()"><i class="bi bi-box-arrow-right text-xl text-red-500 w-8"></i><p class="font-semibold text-red-500 ml-4">Logout</p></div></div></main>`;checkForNewMail()}else{c.innerHTML='<div class="h-screen flex flex-col justify-center items-center text-center p-4"><h1 class="text-xl font-bold mb-4">Welcome to Reoffy Pakistan</h1><p>Please log in or sign up to continue.</p><button onclick="navigateTo(\'auth-screen\')" class="mt-6 bg-accent text-white font-bold py-3 px-8 rounded-lg">Login / Sign Up</button></div>'}}
            async function renderSettingsScreen(){if(!currentUserProfile)return;document.getElementById('settings-username').value=currentUserProfile.username||'';document.getElementById('settings-email').value=currentUserProfile.email||'';document.getElementById('settings-phone').value=currentUserProfile.phone||'';const p=ref(db,`users/${currentUser.uid}/paymentInfo`),s=await get(p);if(s.exists()){const d=s.val();document.getElementById('easypaisa-name').value=d.easypaisa?.name||'';document.getElementById('easypaisa-number').value=d.easypaisa?.number||'';document.getElementById('jazzcash-name').value=d.jazzcash?.name||'';document.getElementById('jazzcash-number').value=d.jazzcash?.number||''}}
            window.savePersonalInformation=async()=>{if(!currentUser)return showToast("Please log in.", "error");const n=document.getElementById('settings-username').value.trim(),p=document.getElementById('settings-phone').value.trim();if(!n)return showToast("Username cannot be empty.", "error");try{await updateProfile(auth.currentUser,{displayName:n});await update(ref(db,`users/${currentUser.uid}`),{username:n,phone:p});showToast("Information saved!", "success")}catch(e){showToast("Failed to save: "+e.message, "error")}};window.savePaymentDetails=async()=>{if(!currentUser)return showToast("Please log in.", "error");const d={easypaisa:{name:document.getElementById('easypaisa-name').value.trim(),number:document.getElementById('easypaisa-number').value.trim()},jazzcash:{name:document.getElementById('jazzcash-name').value.trim(),number:document.getElementById('jazzcash-number').value.trim()}};try{await update(ref(db,`users/${currentUser.uid}/paymentInfo`),d);showToast("Payment details saved!", "success")}catch(e){showToast("Failed to save: "+e.message, "error")}};
            
            // --- INVITE & REFERRAL SCREEN ---
            function renderInviteScreen() {
                if (!currentUserProfile) return;
                const codeDisplay = document.getElementById('referral-code-display');
                codeDisplay.textContent = currentUserProfile.referralCode || 'No Code';
            }
            window.copyReferralCode = () => {
                if (!currentUserProfile || !currentUserProfile.referralCode) return;
                navigator.clipboard.writeText(currentUserProfile.referralCode).then(() => {
                    showToast('Referral code copied!', 'success');
                });
            };
            window.copyReferralLink = () => {
                if (!currentUserProfile || !currentUserProfile.referralCode) return;
                const link = `${window.location.origin}${window.location.pathname}?ref=${currentUserProfile.referralCode}`;
                navigator.clipboard.writeText(link).then(() => {
                    showToast('Referral link copied!', 'success');
                });
            };

            // --- IMAGE UPLOAD & AD POSTING ---
            const uploadImageToImgBB=(f,p)=>{const s=p?document.getElementById(`status_${p}`):null,i=p?document.getElementById(`icon_${p}`):null;if(s)s.textContent='Uploading...';if(i)i.innerHTML=`<div class="mini-loader"></div>`;return new Promise((res,rej)=>{const d=new FormData();d.append('image',f);fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:'POST',body:d}).then(r=>r.json()).then(r=>{if(r.success){if(s)s.textContent='Uploaded!';if(i)i.innerHTML=`<i class="bi bi-check-circle-fill text-green-500"></i>`;res({url:r.data.url,previewId:p})}else{throw new Error(r.error?.message||'Upload failed')}}).catch(e=>{if(s)s.textContent='Failed!';if(i)i.innerHTML=`<i class="bi bi-exclamation-triangle-fill text-red-500"></i>`;rej({error:e,previewId:p})})})};document.getElementById('image-upload-input').addEventListener('change',e=>{const f=Array.from(e.target.files);if(uploadedImageUrls.length+f.length>5){showToast('You can only upload a maximum of 5 images.', 'error');e.target.value='';return}f.forEach(file=>{const p=`preview_${Date.now()}_${Math.random()}`,r=new FileReader();r.onload=e=>{addPreviewImage(e.target.result,p);uploadImageToImgBB(file,p).then(res=>{uploadedImageUrls.push({url:res.url,previewId:res.previewId})}).catch(err=>{console.error("Upload to ImgBB failed for ad image.",err);showToast("Image upload failed.", 'error');removeImage(p)})};r.readAsDataURL(file)});e.target.value=''});function addPreviewImage(s,p){const d=document.createElement('div');d.className='relative group';d.id=p;d.innerHTML=`<img src="${s}" class="w-full h-24 object-cover rounded-lg"><div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 flex items-center justify-center space-x-1 rounded-b-lg"><span id="icon_${p}"></span><span id="status_${p}">Waiting...</span></div><div onclick="removeImage('${p}')" class="absolute top-1 right-1 bg-black/60 text-white rounded-full w-5 h-5 flex items-center justify-center cursor-pointer opacity-0 group-hover:opacity-100"><i class="bi bi-x-lg text-xs"></i></div>`;document.getElementById('image-preview-container').appendChild(d)}window.removeImage=p=>{document.getElementById(p)?.remove();uploadedImageUrls=uploadedImageUrls.filter(i=>i.previewId!==p)};async function checkAndResetMonthlyCredits(){if(!currentUserProfile)return;const s=await get(ref(db,'config/freeUserPlan'));if(!s.exists())return;const{monthlyAds:m,canBeUnlimited:u}=s.val();if(u&&currentUserProfile.adCredits===-1)return;const l=currentUserProfile.lastCreditReset||0;if(Date.now()-l>2592e6){await update(ref(db,`users/${currentUser.uid}`),{adCredits:m,lastCreditReset:Date.now()});showToast(`Monthly credits reset to ${m}.`, 'success')}}
            
            window.postNewAd = async () => {
                if (!currentUser || !currentUserProfile) return showToast('Please log in to post an ad.', 'error');
                await checkAndResetMonthlyCredits();
                
                const userSnapshot = await get(ref(db, `users/${currentUser.uid}`));
                const latestUserProfile = userSnapshot.val();

                if (document.querySelector('.mini-loader')) return showToast('Wait for images to upload.', 'error');
                if (uploadedImageUrls.length === 0) return showToast('Please upload at least one image.', 'error');
                
                const t = document.getElementById('sell-title').value.trim(), d = document.getElementById('sell-description').value.trim(), p = document.getElementById('sell-price').value.trim(), c = document.getElementById('sell-category').value, loc = document.getElementById('sell-location-text').textContent.trim(), b = document.getElementById('sell-brand-model').value.trim(), cond = document.getElementById('sell-condition').value, showPayment = document.getElementById('sell-show-payment').checked;
                
                if (!t || !p || c === 'Select a category' || loc === 'Select Location' || loc === 'Fetching...') return showToast("Please fill all required fields (*).", 'error');

                const hasCredits = latestUserProfile.adCredits === -1 || latestUserProfile.adCredits > 0;
                const adStatus = hasCredits ? 'active' : 'inactive';

                try {
                    const a = {
                        uid: currentUser.uid, title: t, description: d, price: p, category: c, location: loc, brand: b, condition: cond, 
                        images: uploadedImageUrls.map(i => i.url), mainImage: uploadedImageUrls[0].url, 
                        timestamp: Date.now(), isFeatured: false, status: adStatus, showPaymentDetails: showPayment, visitors: 0
                    };
                    const newAdRef = push(ref(db, 'ads'));
                    await set(newAdRef, a);

                    if (hasCredits && latestUserProfile.adCredits !== -1) {
                         await update(ref(db, `users/${currentUser.uid}`), { adCredits: increment(-1) });
                    }
                    
                    const logMsg = hasCredits ? 'Ad posted successfully!' : 'No credits left. Ad saved as inactive.';
                    const logDetails = hasCredits ? '-1 Ad Credit' : '0 Credits';
                    const logType = hasCredits ? 'ad_post' : 'ad_pending';

                    await logTransaction(logType, `Posted ad: "${t}"`, logDetails);
                    showToast(logMsg, 'success');
                    navigateTo('my-ads-screen');

                } catch (e) {
                    showToast("Failed to post ad: " + e.message, 'error');
                }
            };

            // --- DATA FETCHING & RENDERING (CARDS) ---
            function formatTimeAgo(t){const n=Date.now(),s=Math.floor((n-t)/1e3);if(s<60)return`Just now`;const m=Math.floor(s/60);if(m<60)return`${m}m ago`;const h=Math.floor(m/60);if(h<24)return`${h}h ago`;return`${Math.floor(h/24)}d ago`}
            
            function createProductCardHTML(ad) {
                const action = `viewProductDetail('${ad.id}')`;
                const isLiked = currentUser && ad.likedBy && ad.likedBy[currentUser.uid];
                const likeIconClass = isLiked ? 'bi-heart-fill text-red-500' : 'bi-heart';
                const badgeColor = ad.badge?.color || 'bg-red-500';

                return `
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-md overflow-hidden flex flex-col">
                        <div class="relative">
                            <img src="${ad.mainImage}" alt="${ad.title}" class="w-full h-32 object-cover cursor-pointer" onclick="${action}">
                            ${ad.isFeatured ? '<div class="absolute top-1.5 left-1.5 bg-yellow-400 text-black text-[10px] font-bold px-1.5 py-0.5 rounded">Featured</div>' : ''}
                            ${ad.badge ? `<div class="absolute top-1.5 right-1.5 text-[10px] font-bold px-1.5 py-0.5 rounded text-white ${badgeColor}">${ad.badge.text}</div>` : ''}
                        </div>
                         <div class="p-2 flex flex-col flex-grow">
                             <div class="flex justify-between items-start">
                                <p class="font-bold text-base text-accent cursor-pointer" onclick="${action}">Rs ${parseInt(ad.price).toLocaleString()}</p>
                                <i id="like-icon-${ad.id}" class="bi ${likeIconClass} text-xl cursor-pointer" onclick="toggleLike(event, '${ad.id}')"></i>
                             </div>
                            <h3 class="font-semibold text-sm truncate mt-1 cursor-pointer" onclick="${action}">${ad.title}</h3>
                            <div class="flex-grow"></div>
                            <div class="flex justify-between items-center text-[11px] text-gray-500 dark:text-gray-400 mt-2">
                                <span class="truncate">${ad.location}</span>
                                <span>${formatTimeAgo(ad.timestamp)}</span>
                            </div>
                        </div>
                    </div>`;
            }

            // --- NEW SKELETON LOADER FUNCTIONS ---
            function createSkeletonCardHTML() {
                return `<div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-md overflow-hidden"><div class="w-full h-32 skeleton"></div><div class="p-2 space-y-2"><div class="flex justify-between items-center"><div class="h-4 w-2/5 rounded skeleton"></div><div class="h-5 w-5 rounded-full skeleton"></div></div><div class="h-3.5 w-full rounded skeleton"></div><div class="flex justify-between items-center"><div class="h-3 w-1/3 rounded skeleton"></div><div class="h-3 w-1/4 rounded skeleton"></div></div></div></div>`;
            }
            function showSkeletons() {
                const featuredGrid = document.getElementById('featured-ads-grid'); 
                const freshGrid = document.getElementById('fresh-recommendations-grid');
                let skeletonHTML = createSkeletonCardHTML() + createSkeletonCardHTML() + createSkeletonCardHTML() + createSkeletonCardHTML();
                featuredGrid.innerHTML = skeletonHTML; 
                freshGrid.innerHTML = skeletonHTML;
            }
            
            function createRelatedProductCardHTML(ad) {
                const action = `viewProductDetail('${ad.id}')`;
                return `
                <div class="flex-shrink-0 w-40 bg-light-surface dark:bg-dark-surface rounded-lg shadow-md overflow-hidden" onclick="${action}">
                    <img src="${ad.mainImage}" alt="${ad.title}" class="w-full h-24 object-cover">
                    <div class="p-2">
                        <p class="font-bold text-sm text-accent">Rs ${parseInt(ad.price).toLocaleString()}</p>
                        <h3 class="font-semibold text-xs truncate mt-1">${ad.title}</h3>
                    </div>
                </div>`;
            }
            
            async function fetchAllAds() {
                const adsRef = ref(db, 'ads');
                onValue(query(adsRef, orderByChild('timestamp')), (snapshot) => {
                    allAdsData = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const ad = childSnapshot.val();
                            if (ad.status === 'active') {
                                allAdsData.push({ id: childSnapshot.key, ...ad });
                            }
                        });
                        allAdsData.reverse(); 
                    }
                    renderFilteredAds();
                });
            }

            function renderFilteredAds() {
                const searchTerm = document.getElementById('home-search-input').value.trim().toLowerCase();
                const searchResultsContainer = document.getElementById('search-results-container');
                const defaultHomeContent = document.getElementById('default-home-content');
                
                if (searchTerm) {
                    searchResultsContainer.classList.remove('hidden'); defaultHomeContent.classList.add('hidden');
                    const results = allAdsData.filter(ad => ad.title.toLowerCase().includes(searchTerm));
                    const resultsGrid = document.getElementById('search-results-grid');
                    const noResultsMsg = document.getElementById('search-no-results');
                    resultsGrid.innerHTML = '';
                    if (results.length > 0) {
                        resultsGrid.innerHTML = results.map(ad => createProductCardHTML(ad)).join('');
                        noResultsMsg.classList.add('hidden');
                    } else { noResultsMsg.classList.remove('hidden'); }
                } else {
                    searchResultsContainer.classList.add('hidden'); defaultHomeContent.classList.remove('hidden');
                    const featuredGrid = document.getElementById('featured-ads-grid'); const freshGrid = document.getElementById('fresh-recommendations-grid');
                    const noAdsMessage = document.getElementById('no-ads-found-message'); const adsContainer = document.getElementById('ads-container');

                    let filteredAds = [...allAdsData];
                    if (currentFilters.category !== 'All') filteredAds = filteredAds.filter(ad => ad.category === currentFilters.category);
                    if (currentFilters.location !== 'All Pakistan') filteredAds = filteredAds.filter(ad => ad.location === currentFilters.location);
                    if (currentFilters.brand !== 'All Brands') filteredAds = filteredAds.filter(ad => ad.brand && ad.brand.toLowerCase().includes(currentFilters.brand.toLowerCase()));

                    if (filteredAds.length > 0) {
                        noAdsMessage.classList.add('hidden'); adsContainer.classList.remove('hidden');
                        const featuredAds = filteredAds.filter(ad => ad.isFeatured);
                        const regularAds = filteredAds.filter(ad => !ad.isFeatured);
                        featuredGrid.innerHTML = featuredAds.length > 0 ? featuredAds.slice(0, 4).map(ad => createProductCardHTML(ad)).join('') : '<p class="text-sm text-gray-500 col-span-2">No featured ads in this filter.</p>';
                        freshGrid.innerHTML = regularAds.length > 0 ? regularAds.slice(0, 6).map(ad => createProductCardHTML(ad)).join('') : '<p class="text-sm text-gray-500 col-span-2">No fresh recommendations.</p>';
                    } else {
                        noAdsMessage.classList.remove('hidden'); adsContainer.classList.add('hidden');
                        featuredGrid.innerHTML = ''; freshGrid.innerHTML = '';
                    }
                }
            }
            window.applyCategoryFilter = (category, element) => {
                currentFilters.category = category;
                document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
                element.classList.add('active'); renderFilteredAds();
            };
            window.performSearch = (event) => { renderFilteredAds(); };

            window.renderFeaturedAdsList = () => {
                const grid = document.getElementById('featured-list-grid'); const emptyState = document.getElementById('featured-list-empty-state');
                const searchTerm = document.getElementById('featured-list-search-input').value.trim().toLowerCase();
                let featuredAds = allAdsData.filter(ad => ad.isFeatured);
                if (searchTerm) {
                    featuredAds = featuredAds.filter(ad => ad.title.toLowerCase().includes(searchTerm));
                }
                if (featuredAds.length > 0) {
                    grid.innerHTML = featuredAds.map(ad => createProductCardHTML(ad)).join('');
                    grid.classList.remove('hidden'); emptyState.classList.add('hidden');
                } else {
                    grid.innerHTML = ''; grid.classList.add('hidden'); emptyState.classList.remove('hidden');
                }
            };
            window.renderFreshAdsList = () => {
                const grid = document.getElementById('fresh-list-grid'); const emptyState = document.getElementById('fresh-list-empty-state');
                const searchTerm = document.getElementById('fresh-list-search-input').value.trim().toLowerCase();
                let freshAds = allAdsData.filter(ad => !ad.isFeatured);
                 if (searchTerm) {
                    freshAds = freshAds.filter(ad => ad.title.toLowerCase().includes(searchTerm));
                }
                if (freshAds.length > 0) {
                    grid.innerHTML = freshAds.map(ad => createProductCardHTML(ad)).join('');
                    grid.classList.remove('hidden'); emptyState.classList.add('hidden');
                } else {
                    grid.innerHTML = ''; grid.classList.add('hidden'); emptyState.classList.remove('hidden');
                }
            };
            
            // --- My Ads, Favorites, Product Detail, Like, Edit, Boost Logic ---
            window.switchMyAdsTab = (tabName) => {
                ['active', 'inactive', 'boosted'].forEach(tab => {
                    document.getElementById(`my-ads-${tab}-tab`).classList.remove('active');
                    document.getElementById(`my-ads-${tab}-content`).classList.add('hidden');
                });
                
                document.getElementById(`my-ads-${tabName}-tab`).classList.add('active');
                document.getElementById(`my-ads-${tabName}-content`).classList.remove('hidden');

                const emptyState = document.getElementById('my-ads-empty-state');
                const emptyStateTitle = document.getElementById('my-ads-empty-state-title');
                const contentContainer = document.getElementById(`my-ads-${tabName}-content`);

                if (contentContainer.children.length === 0) {
                    emptyStateTitle.textContent = `You have no ${tabName} ads.`;
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }
            };

            function createMyAdListItemHTML(ad){
                let actionButton = '';
                let statusText = '';
                let statusColor = 'text-gray-500 dark:text-gray-400';

                if (ad.status === 'inactive') {
                    const hasCredits = currentUserProfile && (currentUserProfile.adCredits > 0 || currentUserProfile.adCredits === -1);
                    const buttonClass = hasCredits 
                        ? 'bg-green-500 hover:bg-green-600 text-white' 
                        : 'bg-gray-300 dark:bg-gray-600 text-gray-500 cursor-not-allowed';
                    const titleText = hasCredits ? '' : 'No ad credits available';
                    actionButton = `<button onclick="activateAd(event, '${ad.id}')" class="text-xs font-bold px-3 py-1.5 rounded-md transition-colors flex items-center justify-center space-x-1.5 ${buttonClass}" title="${titleText}"><i class="bi bi-check-circle-fill"></i><span>Activate</span></button>`;
                    statusText = 'Inactive';
                    statusColor = 'text-orange-500 font-semibold';
                } else if (ad.isFeatured) {
                    actionButton = `<button onclick="unboostAd(event, '${ad.id}')" class="bg-gray-500 text-white text-xs font-bold px-3 py-1.5 rounded-md hover:bg-gray-600 transition-colors flex items-center justify-center space-x-1.5"><i class="bi bi-arrow-down-circle-fill"></i><span>Unboost</span></button>`;
                    statusText = 'Featured';
                    statusColor = 'text-yellow-500 font-semibold';
                } else if (ad.status === 'active') {
                    actionButton = `<button onclick="openBoostModal(event, '${ad.id}')" class="bg-yellow-400 text-black text-xs font-bold px-3 py-1.5 rounded-md hover:bg-yellow-500 transition-colors flex items-center justify-center space-x-1.5"><i class="bi bi-rocket-takeoff-fill"></i><span>Boost</span></button>`;
                    statusText = 'Active';
                    statusColor = 'text-green-500 font-semibold';
                } else if (ad.status === 'blocked') {
                    statusText = 'Blocked by Admin';
                    statusColor = 'text-red-500 font-semibold';
                }

                const boostTimerHTML = ad.isFeatured ? `<div id="countdown-${ad.id}" class="text-xs text-blue-500 font-medium mt-1"></div>` : '';

                return `<div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-md p-3 flex items-center space-x-3"><img src="${ad.mainImage}" alt="${ad.title}" class="w-20 h-20 object-cover rounded-md flex-shrink-0"><div class="flex-grow overflow-hidden"><p class="font-semibold truncate">${ad.title}</p><p class="text-accent font-bold text-sm mt-1">Rs ${parseInt(ad.price).toLocaleString()}</p><p class="text-xs ${statusColor} mt-1">${statusText}</p>${boostTimerHTML}</div><div class="flex flex-col space-y-2 items-center flex-shrink-0"><button onclick="editAd('${ad.id}')" class="bg-gray-200 dark:bg-gray-600 text-xs font-bold px-3 py-1.5 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors w-full text-center">Edit</button>${actionButton}</div></div>`;
            }

            function updateAllCountdownTimers(boostedAds) {
                Object.values(boostIntervals).forEach(clearInterval);
                boostedAds.forEach(ad => {
                    if (ad.boostExpiry) {
                        const countdownElement = document.getElementById(`countdown-${ad.id}`);
                        if (countdownElement) {
                            const updateTimer = () => {
                                const now = Date.now();
                                const remaining = ad.boostExpiry - now;
                                if (remaining <= 0) {
                                    countdownElement.textContent = "Expired";
                                    clearInterval(boostIntervals[ad.id]);
                                } else {
                                    const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
                                    const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                                    countdownElement.textContent = `Expires in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
                                }
                            };
                            updateTimer();
                            boostIntervals[ad.id] = setInterval(updateTimer, 1000);
                        }
                    }
                });
            }

            async function checkAndHandleExpiredBoosts(userAds) {
                const now = Date.now();
                const expiredAds = userAds.filter(ad => ad.isFeatured && ad.boostExpiry && ad.boostExpiry < now);
                for (const ad of expiredAds) {
                    await update(ref(db, `ads/${ad.id}`), { isFeatured: false, boostExpiry: null });
                    await logTransaction('boost_expired', `Boost expired for: "${ad.title}"`, `0 Credits`);
                    showToast(`Boost for "${ad.title}" has expired.`, 'success');
                }
            }

            function renderMyAds(){
                if(!currentUser)return;
                const activeContent = document.getElementById('my-ads-active-content');
                const inactiveContent = document.getElementById('my-ads-inactive-content');
                const boostedContent = document.getElementById('my-ads-boosted-content');
                const alertContainer = document.getElementById('my-ads-activation-alert');
                const userAdsQuery = query(ref(db, 'ads'), orderByChild('uid'), equalTo(currentUser.uid));
                
                onValue(userAdsQuery, async (snapshot) => {
                    activeContent.innerHTML = ''; inactiveContent.innerHTML = ''; boostedContent.innerHTML = '';
                    alertContainer.innerHTML = ''; alertContainer.classList.add('hidden');
                    let allUserAds = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => { allUserAds.push({id: childSnapshot.key, ...childSnapshot.val()}); });
                    }
                    
                    await checkAndHandleExpiredBoosts(allUserAds);
                    
                    const activeAds = allUserAds.filter(ad => ad.status === 'active' && !ad.isFeatured).reverse();
                    const inactiveAds = allUserAds.filter(ad => ad.status === 'inactive').reverse();
                    const boostedAds = allUserAds.filter(ad => ad.isFeatured).reverse();

                    if (activeAds.length > 0) activeContent.innerHTML = activeAds.map(ad => createMyAdListItemHTML(ad)).join('');
                    if (inactiveAds.length > 0) inactiveContent.innerHTML = inactiveAds.map(ad => createMyAdListItemHTML(ad)).join('');
                    if (boostedAds.length > 0) boostedContent.innerHTML = boostedAds.map(ad => createMyAdListItemHTML(ad)).join('');
                    
                    if (inactiveAds.length > 0 && currentUserProfile && (currentUserProfile.adCredits > 0 || currentUserProfile.adCredits === -1)) {
                        alertContainer.innerHTML = `<div class="bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 text-blue-700 dark:text-blue-200 p-4 rounded-lg mb-4 flex justify-between items-center"><div><p class="font-bold">Activate Your Ads!</p><p class="text-sm">You have available credits to make your inactive ads live.</p></div><button onclick="document.getElementById('my-ads-activation-alert').style.display='none'"><i class="bi bi-x-lg"></i></button></div>`;
                        alertContainer.classList.remove('hidden');
                    }

                    updateAllCountdownTimers(boostedAds);

                    const currentActiveTab = document.querySelector('.my-ads-tab.active')?.id.split('-')[2];
                    switchMyAdsTab(currentActiveTab || 'active');
                });
            }

            window.activateAd = async (event, adId) => {
                event.stopPropagation();
                if (!currentUserProfile) return;
                
                const hasCredits = currentUserProfile.adCredits > 0 || currentUserProfile.adCredits === -1;
                if (!hasCredits) {
                    showToast("You need ad credits to activate this ad.", "error");
                    return;
                }

                if (confirm("This will use 1 ad credit. Do you want to activate this ad?")) {
                    try {
                        await update(ref(db, `ads/${adId}`), { status: 'active' });
                        if (currentUserProfile.adCredits !== -1) {
                            await update(ref(db, `users/${currentUser.uid}`), { adCredits: increment(-1) });
                        }
                        const adSnap = await get(ref(db, `ads/${adId}`));
                        await logTransaction('ad_activate', `Activated ad: "${adSnap.val().title}"`, `-1 Ad Credit`);
                        showToast("Ad activated successfully!", "success");
                    } catch (error) {
                        showToast("Failed to activate ad: " + error.message, "error");
                    }
                }
            };

            function renderFavorites() { if(!currentUser) return; const grid = document.getElementById('favorites-grid'); const emptyState = document.getElementById('favorites-empty-state'); const favoriteAds = allAdsData.filter(ad => ad.likedBy && ad.likedBy[currentUser.uid]); if(favoriteAds.length > 0) { grid.innerHTML = favoriteAds.map(ad => createProductCardHTML(ad)).join(''); grid.classList.remove('hidden'); emptyState.classList.add('hidden'); } else { grid.innerHTML = ''; grid.classList.add('hidden'); emptyState.classList.remove('hidden'); } }
            
            window.viewProductDetail = adId => { 
                let viewedAds = JSON.parse(localStorage.getItem('viewedAds')) || []; 
                if (!viewedAds.includes(adId)) { 
                    update(ref(db, `ads/${adId}`), { visitors: increment(1) }); 
                    viewedAds.push(adId); 
                    localStorage.setItem('viewedAds', JSON.stringify(viewedAds)); 
                } 
                get(child(ref(db), `ads/${adId}`)).then(snapshot => { 
                    if (snapshot.exists()) { 
                        currentViewingAd = { id: snapshot.key, ...snapshot.val() }; 
                        populateProductDetail(currentViewingAd); 
                    } else { 
                        showToast("Ad details not found.", "error"); 
                    } 
                }); 
            };
            
            async function populateProductDetail(ad){
                populateProductImageSlider(ad.images);
                document.getElementById('product-detail-price').textContent=`Rs ${parseInt(ad.price).toLocaleString()}`;
                document.getElementById('product-detail-title').textContent=ad.title;
                document.getElementById('product-detail-location').textContent=ad.location;
                document.getElementById('product-detail-time').textContent=formatTimeAgo(ad.timestamp);
                document.getElementById('product-detail-visitors').textContent = `${ad.visitors || 0} Visitors`; 
                const detailsContainer=document.getElementById('product-details-table');
                detailsContainer.innerHTML=`
                    ${ad.brand ? `<div class="flex justify-between p-3 border-b border-light-border dark:border-dark-border"><span class="text-gray-600 dark:text-gray-400">Brand</span><span class="font-semibold">${ad.brand}</span></div>` : ''}
                    ${ad.condition ? `<div class="flex justify-between p-3 ${ad.category ? 'border-b border-light-border dark:border-dark-border' : ''}"><span class="text-gray-600 dark:text-gray-400">Condition</span><span class="font-semibold">${ad.condition}</span></div>` : ''}
                    ${ad.category ? `<div class="flex justify-between p-3"><span class="text-gray-600 dark:text-gray-400">Category</span><span class="font-semibold">${ad.category}</span></div>` : ''}
                `;

                renderEventBannerOnProductPage();

                document.getElementById('product-detail-description').textContent = ad.description || 'No description provided.';
                
                const likeIcon = document.getElementById('product-detail-like-icon');
                const isLiked = currentUser && ad.likedBy && ad.likedBy[currentUser.uid];
                if (isLiked) {
                    likeIcon.classList.replace('bi-heart', 'bi-heart-fill');
                    likeIcon.classList.add('text-red-500');
                } else {
                    likeIcon.classList.replace('bi-heart-fill', 'bi-heart');
                    likeIcon.classList.remove('text-red-500');
                }

                renderRelatedAds(ad.id);

                const sellerPaymentContainer = document.getElementById('seller-payment-info');
                sellerPaymentContainer.classList.add('hidden');
                const sellerSnap=await get(ref(db,`users/${ad.uid}`));
                if(sellerSnap.exists()){
                    const seller=sellerSnap.val();
                    document.getElementById('seller-info-name').textContent=seller.username;document.getElementById('seller-info-avatar').src=seller.avatar;document.getElementById('seller-member-since').textContent=new Date(seller.memberSince).getFullYear();
                    const sellerInfoNameDiv = document.getElementById('seller-info-name').parentElement;
                    sellerInfoNameDiv.querySelector('.verified-badge')?.remove();
                    if(seller.isVerified) { sellerInfoNameDiv.innerHTML += `<span class="verified-badge"><i class="bi bi-patch-check-fill"></i></span>`; }
                    const adsQuery=query(ref(db,'ads'),orderByChild('uid'),equalTo(ad.uid)),adsSnap=await get(adsQuery),adCount=adsSnap.exists()?Object.keys(adsSnap.val()).length:0;document.getElementById('seller-active-ads').textContent=adCount; 
                    setupWhatsAppButton(seller);
                    
                    if(ad.showPaymentDetails && seller.paymentInfo) {
                        const paymentDetailsHTML = `${seller.paymentInfo.easypaisa?.number ? `<div class="border-b border-light-border dark:border-dark-border pb-3"><h4 class="font-semibold text-green-500 mb-2">Easypaisa</h4><div class="flex justify-between text-sm"><span class="text-gray-500">Title:</span><span>${seller.paymentInfo.easypaisa.name}</span></div><div class="flex justify-between text-sm"><span class="text-gray-500">Number:</span><span>${seller.paymentInfo.easypaisa.number}</span></div></div>` : ''}${seller.paymentInfo.jazzcash?.number ? `<div class="pt-3"><h4 class="font-semibold text-red-500 mb-2">Jazzcash</h4><div class="flex justify-between text-sm"><span class="text-gray-500">Title:</span><span>${seller.paymentInfo.jazzcash.name}</span></div><div class="flex justify-between text-sm"><span class="text-gray-500">Number:</span><span>${seller.paymentInfo.jazzcash.number}</span></div></div>` : ''}`;
                        if(paymentDetailsHTML.trim()) {
                           document.getElementById('seller-payment-details-container').innerHTML = paymentDetailsHTML;
                           sellerPaymentContainer.classList.remove('hidden');
                        }
                    }
                } else { setupWhatsAppButton(null); } 
                navigateTo('product-detail-screen');
            }
            
            function renderRelatedAds(currentAdId) {
                const container = document.getElementById('related-ads-container');
                const relatedAds = allAdsData.filter(ad => ad.isFeatured && ad.id !== currentAdId).slice(0, 6);
                if (relatedAds.length > 0) {
                    container.innerHTML = relatedAds.map(ad => createRelatedProductCardHTML(ad)).join('');
                    document.getElementById('related-ads-section').style.display = 'block';
                } else {
                    container.innerHTML = '';
                    document.getElementById('related-ads-section').style.display = 'none';
                }
            }
            
            window.toggleLike = async (event, adId) => {
                event.stopPropagation();
                if (!currentUser) {
                    showToast("Please log in to like ads.", "error");
                    nextScreenAfterLogin = { screenId: historyStack[historyStack.length - 1] };
                    navigateTo('auth-screen');
                    return;
                }

                const adRef = ref(db, `ads/${adId}`);
                const adSnap = await get(adRef);
                if (!adSnap.exists()) return;

                const adData = adSnap.val();
                const likedBy = adData.likedBy || {};
                const isCurrentlyLiked = likedBy[currentUser.uid];

                const likeIconInGrid = document.getElementById(`like-icon-${adId}`);
                const likeIconInDetail = document.getElementById('product-detail-like-icon');

                const updateIcons = (liked) => {
                    const addClass = liked ? 'bi-heart-fill' : 'bi-heart';
                    const removeClass = liked ? 'bi-heart' : 'bi-heart-fill';
                    const colorClass = 'text-red-500';

                    if (likeIconInGrid) {
                        likeIconInGrid.classList.replace(removeClass, addClass);
                        if (liked) likeIconInGrid.classList.add(colorClass); else likeIconInGrid.classList.remove(colorClass);
                    }
                    if (likeIconInDetail && currentViewingAd && currentViewingAd.id === adId) {
                        likeIconInDetail.classList.replace(removeClass, addClass);
                        if (liked) likeIconInDetail.classList.add(colorClass); else likeIconInDetail.classList.remove(colorClass);
                    }
                };

                updateIcons(!isCurrentlyLiked);

                try {
                    if (isCurrentlyLiked) {
                        delete likedBy[currentUser.uid];
                    } else {
                        likedBy[currentUser.uid] = true;
                    }
                    await update(adRef, { likedBy: likedBy });

                    const adIndex = allAdsData.findIndex(ad => ad.id === adId);
                    if (adIndex > -1) {
                        allAdsData[adIndex].likedBy = likedBy;
                    }

                } catch (error) {
                    console.error("Like toggle failed:", error);
                    showToast("An error occurred.", "error");
                    updateIcons(isCurrentlyLiked);
                }
            };
            
            window.editAd=adId=>{get(child(ref(db),`ads/${adId}`)).then(snapshot=>{if(snapshot.exists()){currentEditingAd={id:snapshot.key,...snapshot.val()};document.getElementById('edit-title').value=currentEditingAd.title;document.getElementById('edit-description').value=currentEditingAd.description||'';document.getElementById('edit-category').value=currentEditingAd.category;document.getElementById('edit-location-text').textContent=currentEditingAd.location;document.getElementById('edit-price-display').textContent=`Rs ${parseInt(currentEditingAd.price).toLocaleString()}`;const imageContainer=document.getElementById('edit-image-preview-container');imageContainer.innerHTML=currentEditingAd.images.map(url=>`<img src="${url}" class="w-full h-24 object-cover rounded-lg">`).join('');navigateTo('edit-ad-screen')}else{showToast("Could not find ad to edit.", "error")}})};window.saveAdChanges=async()=>{if(!currentEditingAd)return;const updatedData={title:document.getElementById('edit-title').value.trim(),description:document.getElementById('edit-description').value.trim(),category:document.getElementById('edit-category').value,location:document.getElementById('edit-location-text').textContent.trim()};if(!updatedData.title||!updatedData.location)return showToast("Title and Location are required.", "error");try{await update(ref(db,`ads/${currentEditingAd.id}`),updatedData);showToast("Ad updated!", "success");navigateTo('my-ads-screen')}catch(error){showToast("Update failed: "+error.message, "error")}};
            window.deleteAd=async()=>{if(!currentEditingAd)return;const adTitle = currentEditingAd.title; if(confirm("Are you sure you want to delete this ad?")){try{await remove(ref(db,`ads/${currentEditingAd.id}`));await logTransaction('ad_delete', `Deleted ad: "${adTitle}"`, `Ad slot freed`);showToast("Ad deleted.", "success");navigateTo('my-ads-screen')}catch(error){showToast("Failed to delete ad: "+error.message, "error")}}};
            
            window.openBoostModal = (event, adId) => {
                event.stopPropagation();
                if (!currentUserProfile) {
                    showToast('Please login first to boost ads.', 'error');
                    navigateTo('auth-screen');
                    return;
                }
                currentBoostingAdId = adId;
                document.getElementById('boost-credits-count').textContent = currentUserProfile.boostCredits || 0;
                openModal('boost-options-modal');
            };

            window.confirmBoost = async (duration, cost) => {
                if (!currentBoostingAdId || !currentUserProfile) return;
                if (currentUserProfile.boostCredits < cost) {
                    showToast("Not enough boost credits. Please buy a package.", "error");
                    closeModal('boost-options-modal');
                    navigateTo('plans-screen');
                    return;
                }

                const adRef = ref(db, `ads/${currentBoostingAdId}`);
                const adSnap = await get(adRef);
                if (!adSnap.exists()) return showToast("Ad not found.", "error");

                try {
                    const boostExpiry = Date.now() + (duration * 24 * 60 * 60 * 1000);
                    await update(adRef, { isFeatured: true, boostExpiry: boostExpiry });
                    await update(ref(db, `users/${currentUser.uid}`), { boostCredits: increment(-cost) });
                    await logTransaction('ad_boost', `Boosted ad for ${duration} days`, `-${cost} Boost Credits`);
                    
                    showToast(`Ad boosted for ${duration} days!`, "success");
                    closeModal('boost-options-modal');
                    currentBoostingAdId = null;
                } catch (error) {
                    showToast("Failed to boost ad: " + error.message, "error");
                }
            };
            
            window.unboostAd = async (event, adId) => { event.stopPropagation(); if (confirm("Are you sure you want to unboost this ad? Your credits will not be refunded.")) { try { await update(ref(db, `ads/${adId}`), { isFeatured: false, boostExpiry: null }); showToast("Ad unboosted.", "success"); } catch (error) { showToast("Failed to unboost ad: " + error.message, "error"); } } };

            // --- WHATSAPP ORDER ---
            function setupWhatsAppButton(seller) { const btn = document.getElementById('whatsapp-order-btn'); if (seller && seller.phone && seller.whatsAppUnlocked) { btn.disabled = false; } else { btn.disabled = true; } }
            window.orderOnWhatsApp = async () => { if (!currentViewingAd) return; const sellerSnap = await get(ref(db, `users/${currentViewingAd.uid}`)); if (!sellerSnap.exists()) { showToast("Seller not found.", "error"); return; } const seller = sellerSnap.val(); if (!seller.phone || !seller.whatsAppUnlocked) { showToast("Seller does not accept WhatsApp orders.", "error"); return; } const title = currentViewingAd.title; const price = `Rs ${parseInt(currentViewingAd.price).toLocaleString()}`; const message = `Hi, I'm interested in your ad on Reoffy Pakistan:\n\n*${title}*\nPrice: *${price}*\n\nIs this still available?`; const whatsappUrl = `https://wa.me/${seller.phone}?text=${encodeURIComponent(message)}`; window.open(whatsappUrl, '_blank'); };

            // --- PAYMENT SCREEN FUNCTIONS ---
            window.selectPaymentMethod = (method) => {
                const easypaisaTab = document.getElementById('easypaisa-tab');
                const jazzcashTab = document.getElementById('jazzcash-tab');
                const easypaisaDetails = document.getElementById('payment-details-easypaisa');
                const jazzcashDetails = document.getElementById('payment-details-jazzcash');

                if (method === 'easypaisa') {
                    easypaisaTab.classList.add('active');
                    jazzcashTab.classList.remove('active');
                    easypaisaDetails.classList.remove('hidden');
                    jazzcashDetails.classList.add('hidden');
                } else if (method === 'jazzcash') {
                    easypaisaTab.classList.remove('active');
                    jazzcashTab.classList.add('active');
                    easypaisaDetails.classList.add('hidden');
                    jazzcashDetails.classList.remove('hidden');
                }
            };

            window.copyToClipboard = (elementId) => {
                const textToCopy = document.getElementById(elementId).textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Number copied!', 'success');
                }).catch(err => {
                    showToast('Failed to copy number.', 'error');
                    console.error('Copy failed', err);
                });
            };

            // --- PACKAGE PURCHASE FLOW ---
            async function renderPlans() {
                const plansContainer = document.getElementById('plans-container');
                plansContainer.innerHTML = '<div class="screen-loader"><div class="loader"></div></div>';
                const plansRef = ref(db, 'config/plans');
                const snapshot = await get(plansRef);
                if (snapshot.exists()) {
                    plansContainer.innerHTML = '';
                    snapshot.forEach(child => {
                        const planId = child.key; const plan = child.val();
                        let durationText = '/ Lifetime';
                        if (plan.duration > 0) {
                            if (plan.duration % 30 === 0) { const months = plan.duration / 30; durationText = `/ ${months} Month${months > 1 ? 's' : ''}`; } 
                            else { durationText = `/ ${plan.duration} days`; }
                        }

                        const priceHTML = plan.originalPrice && plan.originalPrice > plan.price
                            ? `<p class="text-4xl font-extrabold my-4"><span class="text-2xl font-normal text-gray-500 line-through mr-2">Rs ${plan.originalPrice}</span>Rs ${plan.price}<span class="text-base font-normal text-gray-500 dark:text-gray-400">${durationText}</span></p>`
                            : `<p class="text-4xl font-extrabold my-4">Rs ${plan.price}<span class="text-base font-normal text-gray-500 dark:text-gray-400">${durationText}</span></p>`;

                        let featuresHTML = `<li class="flex items-center"><i class="bi bi-check-circle-fill text-accent mr-3"></i> ${plan.adCredits === -1 ? 'Unlimited' : plan.adCredits} Ad Listings</li><li class="flex items-center"><i class="bi bi-check-circle-fill text-accent mr-3"></i> ${plan.boostCredits} Featured Ads (Boosts)</li>`;
                        if (plan.grantsVerifiedBadge) featuresHTML += `<li class="flex items-center"><i class="bi bi-patch-check-fill text-accent mr-3"></i> Permanent Verified Badge</li>`;
                        if (plan.unlocksWhatsAppButton) featuresHTML += `<li class="flex items-center"><i class="bi bi-whatsapp text-accent mr-3"></i> Unlock WhatsApp Orders</li>`;

                        if (plan.features && Array.isArray(plan.features)) {
                            plan.features.forEach(feature => {
                                featuresHTML += `<li class="flex items-center"><i class="bi bi-star-fill text-accent mr-3"></i> ${feature}</li>`;
                            });
                        }

                        plansContainer.innerHTML += `<div class="bg-light-surface dark:bg-dark-surface border-2 border-accent p-6 rounded-lg text-center shadow-lg shadow-accent/20"><h3 class="text-2xl font-bold text-accent">${plan.name}</h3>${priceHTML}<ul class="space-y-3 text-left text-gray-700 dark:text-gray-300 my-6">${featuresHTML}</ul><button class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg text-lg transition-colors" onclick="navigateTo('payment-screen', false, { planId: '${planId}', planName: '${plan.name}', price: ${plan.price} })">Choose ${plan.name}</button></div>`;
                    });
                } else { plansContainer.innerHTML = '<p class="text-center text-gray-500">No subscription plans available.</p>'; }
            }
            window.updateScreenshotName = () => { const i=document.getElementById('screenshot-input'),l=document.getElementById('screenshot-label');if(i.files&&i.files.length>0){screenshotFile=i.files[0];l.textContent=screenshotFile.name}else{screenshotFile=null;l.textContent='Upload Screenshot'} };
            window.submitForReview=async()=>{const t=document.getElementById('transaction-id-input').value.trim();if(!t||!screenshotFile)return showToast("Provide TID and screenshot.", "error");if(!currentUser)return showToast("Please log in.", "error");const b=document.getElementById('submit-review-btn');b.disabled=true;b.innerHTML=`<div class="mini-loader mx-auto"></div>`;try{const{url:s}=await uploadImageToImgBB(screenshotFile),p={userId:currentUser.uid,username:currentUserProfile.username,tid:t,screenshotUrl:s,planId:currentPurchaseDetails.planId,planName:currentPurchaseDetails.planName,price:currentPurchaseDetails.price,status:'pending',timestamp:Date.now()};await push(ref(db,'payment-requests'),p);navigateTo('pending-approval-screen')}catch(e){showToast("Submission failed: "+e.message, "error")}finally{b.disabled=false;b.textContent='Submit for Review';document.getElementById('transaction-id-input').value='';screenshotFile=null;document.getElementById('screenshot-input').value='';document.getElementById('screenshot-label').textContent='Upload Screenshot'}};
            
            // --- PUBLIC PROFILE & CHAT ---
            window.viewPublicProfile=async uid=>{
                if(!uid)return;
                const u=await get(ref(db,`users/${uid}`));
                if(!u.exists())return showToast("Seller profile not found.", "error");
                const p=u.val();
                document.getElementById('public-profile-avatar').src=p.avatar; document.getElementById('public-profile-name').textContent=p.username;
                document.getElementById('public-profile-member-since').textContent=`Member since ${new Date(p.memberSince).getFullYear()}`;
                document.getElementById('public-profile-ad-credits').textContent=p.adCredits===-1?'Unlimited':p.adCredits??0;
                document.getElementById('public-profile-boost-credits').textContent=p.boostCredits??0;
                document.getElementById('profile-upload-icon').style.display=currentUser&&currentUser.uid===uid?'flex':'none'; 
                const badge = document.getElementById('verified-seller-badge'); 
                if (p.isVerified) { badge.classList.remove('hidden'); badge.classList.add('inline-flex'); } else { badge.classList.add('hidden'); } 
                const g=document.getElementById('public-profile-ads-grid'),e=document.getElementById('public-profile-empty-state'),s=await get(query(ref(db,'ads'),orderByChild('uid'),equalTo(uid)));
                g.innerHTML='';
                if(s.exists()){
                    let r=[]; s.forEach(c=>{ if(c.val().status==='active')r.push({id:c.key,...c.val()}) });
                    r.reverse();
                    if(r.length>0){ g.innerHTML=r.map(d=>createProductCardHTML(d)).join(''); e.classList.add('hidden') }
                    else{ e.classList.remove('hidden') }
                }else{ e.classList.remove('hidden') }
                navigateTo('public-profile-screen')
            };
            window.handleProfilePictureChange=async e=>{
                const f=e.target.files[0]; if(!f||!currentUser)return;
                const i=document.getElementById('profile-upload-icon'); i.innerHTML=`<div class="loader"></div>`;
                try{ const{url:n}=await uploadImageToImgBB(f);
                    await updateProfile(auth.currentUser,{photoURL:n}); await update(ref(db,`users/${currentUser.uid}`),{avatar:n});
                    document.getElementById('public-profile-avatar').src=n; showToast("Profile picture updated!", "success")
                }catch(err){ console.error("Profile picture upload failed:",err); showToast("Upload failed.", "error")
                }finally{ i.innerHTML=`<i class="bi bi-pencil-fill"></i>` }
            };
            async function openChatWithDetails(k,a,o){
                currentChatKey=k;
                document.getElementById('chat-detail-name').textContent=o.username; document.getElementById('chat-detail-avatar').src=o.avatar;
                document.getElementById('chat-detail-product').textContent=`Regarding: ${a.title}`;
                const nameContainer = document.getElementById('chat-detail-name').parentElement;
                nameContainer.querySelector('.verified-badge')?.remove();
                if(o.isVerified) { nameContainer.innerHTML += `<span class="verified-badge"><i class="bi bi-patch-check-fill"></i></span>`; }
                navigateTo('chat-detail-screen');
                await set(ref(db,`user-chats/${currentUser.uid}/${k}`),Date.now());
                const m=document.getElementById('chat-messages-container'),r=ref(db,`messages/${currentChatKey}`);
                chatListener=onValue(query(r,orderByChild('timestamp')),s=>{
                    m.innerHTML='';
                    if(s.exists()){ s.forEach(c=>{ const g=c.val(),b=document.createElement('div');
                            if(g.type === 'image') {
                                b.innerHTML = `<img src="${g.content}" alt="Chat Image">`;
                                b.classList.add('chat-bubble', 'chat-bubble-image', g.senderId === currentUser.uid ? 'chat-bubble-sent' : 'chat-bubble-received');
                            } else {
                                b.textContent=g.content; 
                                b.classList.add('chat-bubble',g.senderId===currentUser.uid?'chat-bubble-sent':'chat-bubble-received');
                            }
                            m.appendChild(b) }) }
                    m.scrollTop=m.scrollHeight
                })
            }
            window.startChat=async()=>{
                if(!currentUser){ nextScreenAfterLogin={screenId: 'product-detail-screen', params: currentViewingAd?.id }; return navigateTo('auth-screen'); }
                if(!currentViewingAd)return showToast("Ad details missing.", "error");
                if(currentUser.uid===currentViewingAd.uid)return showToast("You cannot chat on your own ad.", "error");
                const s=currentViewingAd.uid,a=currentViewingAd.id,k=[currentUser.uid,s].sort().join('_')+'_'+a,u=await get(ref(db,`users/${s}`)),p=u.exists()?u.val():{uid:s,username:"Seller",avatar:`https://i.pravatar.cc/150?u=${s}`};
                const c=await get(ref(db,`chats/${k}`));
                if(!c.exists()){
                    const t=Date.now(),d={adId:a,adTitle:currentViewingAd.title,adImage:currentViewingAd.mainImage,participants:{[currentUser.uid]:true,[s]:true},lastMessage:"",timestamp:t};
                    await set(ref(db,`chats/${k}`),d); await set(ref(db,`user-chats/${currentUser.uid}/${k}`),t); await set(ref(db,`user-chats/${s}/${k}`),t)
                }
                openChatWithDetails(k,currentViewingAd,p)
            };

            async function sendChatMessage(messageData) {
                if(!currentChatKey || !currentUser) return;
                const timestamp = Date.now();
                const lastMessageText = messageData.type === 'image' ? 'Photo' : messageData.content;
                const finalMessage = { ...messageData, senderId: currentUser.uid, timestamp: timestamp };
                await push(ref(db, `messages/${currentChatKey}`), finalMessage);
                await update(ref(db, `chats/${currentChatKey}`), { lastMessage: lastMessageText, timestamp: timestamp });
            }

            window.sendMessage=async()=>{ const input = document.getElementById('chat-input'), text = input.value.trim(); if (!text) return;
                sendChatMessage({ type: 'text', content: text }); input.value = '';
            };
            window.handleChatImageSelection = async (event) => {
                const file = event.target.files[0]; if (!file) return;
                const sendBtn = document.getElementById('chat-send-btn'); sendBtn.disabled = true;
                sendBtn.innerHTML = '<div class="mini-loader mx-auto"></div>';
                try {
                    const { url } = await uploadImageToImgBB(file);
                    await sendChatMessage({ type: 'image', content: url });
                } catch(err) {
                    showToast('Image could not be sent.', 'error');
                } finally {
                    sendBtn.disabled = false; sendBtn.innerHTML = '<i class="bi bi-send-fill text-xl"></i>';
                    event.target.value = '';
                }
            };

            window.openExistingChat=async(k,o)=>{ const c=await get(ref(db,`chats/${k}`)); if(!c.exists())return showToast("Chat not found.", "error");
                const d=c.val(),a=await get(ref(db,`ads/${d.adId}`)),ad=a.exists()?a.val():{title:"Deleted Ad"},u=await get(ref(db,`users/${o}`)),ud=u.exists()?u.val():{username:'User',avatar:'https://i.pravatar.cc/150'};
                openChatWithDetails(k,ad,ud)
            };
            async function renderChatList(){
                if(!currentUser)return;
                const c=document.getElementById('chat-list'),e=document.getElementById('chat-empty-state'),r=ref(db,`user-chats/${currentUser.uid}`);
                onValue(r,async s=>{ c.innerHTML='<div class="screen-loader"><div class="loader"></div></div>';
                    if(s.exists()){ e.style.display='none';
                        const d=s.val(),k=Object.keys(d),p=k.map(key=>get(ref(db,`chats/${key}`)).then(v=>({key,...v.val()}))),m=(await Promise.all(p)).filter(v=>v.participants);
                        m.sort((a,b)=>b.timestamp-a.timestamp); const u={};
                        m.forEach(chat=>{ const o=Object.keys(chat.participants).find(id=>id!==currentUser.uid); if(o&&!u[o])u[o]=get(ref(db,`users/${o}`)) });
                        const n=await Promise.all(Object.values(u)),users={};
                        Object.keys(u).forEach((uid,i)=>{ users[uid]=n[i].val()||{username:'User',avatar:`https://i.pravatar.cc/150?u=${uid}`} });
                        let h=''; m.forEach(chat=>{ const o=Object.keys(chat.participants).find(id=>id!==currentUser.uid); if(!o)return;
                            const user=users[o],i=chat.timestamp>(d[chat.key]||0);
                            const verifiedBadgeHTML = user.isVerified ? `<span class="verified-badge"><i class="bi bi-patch-check-fill"></i></span>` : '';
                            h+=`<div class="flex items-center p-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-surface" onclick="openExistingChat('${chat.key}', '${o}')"><img src="${user.avatar}" class="w-14 h-14 rounded-full mr-4 object-cover"><div class="flex-grow overflow-hidden"><div class="flex justify-between items-center"><div class="flex items-center truncate"><p class="font-bold truncate">${user.username}</p>${verifiedBadgeHTML}</div><div class="flex items-center space-x-2"><p class="text-xs text-gray-500 flex-shrink-0 ml-2">${new Date(chat.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</p>${i?'<div class="w-2.5 h-2.5 bg-accent rounded-full"></div>':''}</div></div><p class="text-sm text-gray-600 dark:text-gray-400 truncate">${chat.lastMessage||`About: ${chat.adTitle}`}</p></div></div>`
                        }); c.innerHTML=h
                    }else{ e.style.display='flex'; c.innerHTML='' }
                })
            }

            // --- TRANSACTION LOGGING & HISTORY ---
            async function logTransaction(type, description, details) {
                if (!currentUser) return;
                const transaction = { type: type, description: description, details: details, timestamp: Date.now() };
                await push(ref(db, `users/${currentUser.uid}/transactions`), transaction);
            }
            
            async function renderTransactionHistory() {
                if(!currentUser) return;
                const list = document.getElementById('transaction-list'); const emptyState = document.getElementById('transaction-empty-state');
                const transRef = query(ref(db, `users/${currentUser.uid}/transactions`), orderByChild('timestamp'));

                onValue(transRef, (snapshot) => {
                    list.innerHTML = '';
                    if (snapshot.exists()) { let transactions = []; snapshot.forEach(child => transactions.push(child.val())); transactions.reverse();
                        transactions.forEach(t => {
                            const iconMap = {
                                'plan_purchase': 'bi-bag-check-fill text-green-500', 'ad_post': 'bi-file-earmark-plus-fill text-blue-500',
                                'ad_delete': 'bi-file-earmark-minus-fill text-gray-500', 'ad_boost': 'bi-rocket-takeoff-fill text-yellow-500',
                                'boost_expired': 'bi-hourglass-split text-gray-500', 'referral_reward': 'bi-gift-fill text-pink-500',
                                'ad_pending': 'bi-file-earmark-arrow-down-fill text-orange-500',
                                'ad_activate': 'bi-file-earmark-check-fill text-green-500'
                            };
                            const icon = iconMap[t.type] || 'bi-receipt text-gray-400';
                            list.innerHTML += `<div class="bg-light-surface dark:bg-dark-surface p-3 rounded-lg flex items-center space-x-4"><i class="bi ${icon} text-2xl w-8 text-center"></i><div class="flex-grow"><p class="font-semibold">${t.description}</p><p class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleString()}</p></div><p class="text-sm font-medium text-gray-700 dark:text-gray-300">${t.details}</p></div>`;
                        });
                        list.classList.remove('hidden'); emptyState.classList.add('hidden');
                    } else { list.classList.add('hidden'); emptyState.classList.remove('hidden'); }
                });
            }

            // --- MAILBOX & HELP CENTER ---
            async function openHelpCenter() {
                const container = document.getElementById('help-center-links');
                container.innerHTML = '<p class="text-center text-gray-500">Loading support options...</p>';
                const snap = await get(ref(db, 'config/helpCenter'));
                if (snap.exists()) {
                    const data = snap.val();
                    let html = '';
                    if (data.whatsapp) html += `<a href="${data.whatsapp}" target="_blank" class="flex items-center p-3 bg-light-surface dark:bg-dark-surface rounded-lg text-green-500 font-semibold"><i class="bi bi-whatsapp text-2xl mr-4"></i>Contact on WhatsApp</a>`;
                    if (data.telegram) html += `<a href="${data.telegram}" target="_blank" class="flex items-center p-3 bg-light-surface dark:bg-dark-surface rounded-lg text-blue-500 font-semibold"><i class="bi bi-telegram text-2xl mr-4"></i>Contact on Telegram</a>`;
                    if (data.email) html += `<a href="mailto:${data.email}" class="flex items-center p-3 bg-light-surface dark:bg-dark-surface rounded-lg text-red-500 font-semibold"><i class="bi bi-envelope-at-fill text-2xl mr-4"></i>Contact via Email</a>`;
                    if (data.other?.url) html += `<a href="${data.other.url}" target="_blank" class="flex items-center p-3 bg-light-surface dark:bg-dark-surface rounded-lg font-semibold"><i class="bi bi-info-circle-fill text-2xl mr-4"></i>${data.other.title || 'More Info'}</a>`;
                    container.innerHTML = html || '<p class="text-center text-gray-500">No support options available right now.</p>';
                } else {
                    container.innerHTML = '<p class="text-center text-gray-500">No support options available right now.</p>';
                }
            }
            function updateNotificationDots(show) {
                const accountNavDot = document.getElementById('account-nav-dot'); const mailboxMenuDot = document.getElementById('mailbox-menu-dot');
                if (show) { accountNavDot?.classList.remove('hidden'); mailboxMenuDot?.classList.remove('hidden'); } 
                else { accountNavDot?.classList.add('hidden'); mailboxMenuDot?.classList.add('hidden'); }
            }

            async function checkForNewMail() {
                if (!currentUser) return;
                const mailRef = query(ref(db, 'mailbox'), orderByChild('timestamp'));
                const snapshot = await get(mailRef);
                if (snapshot.exists()) {
                    let latestTimestamp = 0;
                    snapshot.forEach(child => { if (child.val().timestamp > latestTimestamp) latestTimestamp = child.val().timestamp; });
                    const lastRead = localStorage.getItem('lastMailTimestamp') || 0;
                    if (latestTimestamp > lastRead) updateNotificationDots(true); else updateNotificationDots(false);
                }
            }

            async function renderMailbox() {
                if (!currentUser) return;
                const list = document.getElementById('mailbox-list'); const emptyState = document.getElementById('mailbox-empty-state');
                const mailRef = query(ref(db, 'mailbox'), orderByChild('timestamp'));
                 
                onValue(mailRef, (snapshot) => {
                    list.innerHTML = '';
                    if (snapshot.exists()) { let messages = [];
                        snapshot.forEach(child => { const msg = { id: child.key, ...child.val() }; if (msg.recipient === 'all' || msg.recipient === currentUser.uid) messages.push(msg); });
                        messages.reverse();
                        if (messages.length > 0) {
                            messages.forEach(msg => { list.innerHTML += `<div class="p-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-surface" onclick="showMailboxDetail('${msg.id}')"><div class="flex justify-between items-center mb-1"><p class="font-bold">${msg.title}</p><p class="text-xs text-gray-500">${formatTimeAgo(msg.timestamp)}</p></div><p class="text-sm text-gray-600 dark:text-gray-400 truncate">${msg.body}</p></div>`; });
                            list.classList.remove('hidden'); emptyState.classList.add('hidden');
                        } else { list.classList.add('hidden'); emptyState.classList.remove('hidden'); }
                    } else { list.classList.add('hidden'); emptyState.classList.remove('hidden'); }
                });
            }

            window.showMailboxDetail = async (msgId) => {
                const msgSnap = await get(ref(db, `mailbox/${msgId}`)); if (!msgSnap.exists()) return; const msg = msgSnap.val();
                document.getElementById('mailbox-detail-title').textContent = msg.title; document.getElementById('mailbox-detail-body').textContent = msg.body;
                const imgEl = document.getElementById('mailbox-detail-image'); const linkEl = document.getElementById('mailbox-detail-link');
                if (msg.imageUrl) { imgEl.src = msg.imageUrl; imgEl.classList.remove('hidden'); } else { imgEl.classList.add('hidden'); }
                if (msg.linkUrl) { linkEl.href = msg.linkUrl; if(msg.linkText) linkEl.textContent = msg.linkText;
                    linkEl.classList.remove('hidden'); linkEl.style.display = 'block';
                } else { linkEl.classList.add('hidden'); }
                openModal('mailbox-detail-modal');
            };
            
            async function fetchAndDisplayEventBanner() {
                const bannerContainer = document.getElementById('event-banner-container');
                const bannerLink = document.getElementById('event-banner-link');
                const bannerImage = document.getElementById('event-banner-image');
                const bannerCloseBtn = document.getElementById('event-banner-close');

                try {
                    const bannerRef = ref(db, 'config/eventBanner');
                    const snapshot = await get(bannerRef);

                    if (snapshot.exists()) {
                        eventBannerData = snapshot.val(); // Store data globally
                        if (eventBannerData.enabled && eventBannerData.imageUrl && eventBannerData.linkUrl) {
                            
                            bannerImage.src = eventBannerData.imageUrl;

                            bannerLink.addEventListener('click', (e) => {
                                e.preventDefault();
                                if (currentUser) {
                                    window.open(eventBannerData.linkUrl, '_blank');
                                } else {
                                    showToast('Please log in to access this event.', 'error');
                                    navigateTo('auth-screen');
                                }
                            });

                            bannerCloseBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                bannerContainer.classList.remove('show');
                            });

                            setTimeout(() => {
                                bannerContainer.classList.add('show');
                            }, 500);

                        }
                    }
                } catch (error) {
                    console.error("Could not fetch event banner:", error);
                }
            }

            function renderEventBannerOnProductPage() {
                const placeholder = document.getElementById('product-detail-event-banner-placeholder');
                const mainBannerVisible = document.getElementById('event-banner-container').classList.contains('show');

                if (mainBannerVisible && eventBannerData) {
                    const bannerHTML = `
                        <div class="relative max-w-2xl mx-auto rounded-lg overflow-hidden">
                            <a href="#" class="block">
                                <img src="${eventBannerData.imageUrl}" alt="Special Event" class="w-full h-auto object-contain">
                            </a>
                        </div>`;
                    
                    placeholder.innerHTML = bannerHTML;

                    const newBannerLink = placeholder.querySelector('a');
                    if (newBannerLink) {
                        newBannerLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (currentUser) {
                                window.open(eventBannerData.linkUrl, '_blank');
                            } else {
                                showToast('Please log in to access this event.', 'error');
                                navigateTo('auth-screen');
                            }
                        });
                    }
                    placeholder.classList.remove('hidden');
                } else {
                    placeholder.innerHTML = '';
                    placeholder.classList.add('hidden');
                }
            }
            
            let sliderIntervals = new Map();
            function initSlider(container, interval = 3000) {
                const wrapper = container.querySelector('.slider-wrapper'); const slides = container.querySelectorAll('.slider-slide');
                if (slides.length <= 1) return; let currentIndex = 0; let startX = 0; let currentTranslate = 0; let prevTranslate = 0;
                let isDragging = false; let animationId = 0; function setSliderPosition() { wrapper.style.transform = `translateX(${currentTranslate}px)`; }
                function animation() { setSliderPosition(); if (isDragging) requestAnimationFrame(animation); }
                function touchStart(index) { return function (event) { currentIndex = index; startX = event.touches[0].clientX; isDragging = true;
                        animationId = requestAnimationFrame(animation); wrapper.style.transition = 'none'; if (sliderIntervals.has(container)) clearInterval(sliderIntervals.get(container)); }; }
                function touchMove(event) { if (isDragging) { const currentPosition = event.touches[0].clientX; currentTranslate = prevTranslate + currentPosition - startX; } }
                function touchEnd() { isDragging = false; cancelAnimationFrame(animationId); const movedBy = currentTranslate - prevTranslate;
                    if (movedBy < -50 && currentIndex < slides.length - 1) currentIndex++; if (movedBy > 50 && currentIndex > 0) currentIndex--;
                    setPositionByIndex(); wrapper.style.transition = 'transform 0.3s ease-in-out'; startAutoSwipe(); }
                function setPositionByIndex() { currentTranslate = currentIndex * -container.clientWidth; prevTranslate = currentTranslate;
                    setSliderPosition(); if(container.parentElement.id === 'product-image-slider') document.getElementById('image-counter-text').textContent = `${currentIndex + 1}/${slides.length}`; }
                function nextSlide() { currentIndex = (currentIndex + 1) % slides.length; setPositionByIndex(); }
                function startAutoSwipe() { if (sliderIntervals.has(container)) clearInterval(sliderIntervals.get(container));
                     const newIntervalId = setInterval(nextSlide, interval); sliderIntervals.set(container, newIntervalId); }
                slides.forEach((slide, index) => { slide.addEventListener('touchstart', touchStart(index)); slide.addEventListener('touchmove', touchMove); slide.addEventListener('touchend', touchEnd); });
                startAutoSwipe();
            }
            
            function populateProductImageSlider(images) {
                 const sliderContainer = document.getElementById('product-image-slider');
                 if(!images || images.length === 0) { sliderContainer.innerHTML = `<img src="" class="w-full h-72 object-contain" alt="Product Image">`; return; }
                 sliderContainer.innerHTML = `<div class="slider-container h-full"><div class="slider-wrapper h-full">${images.map(img => `<div class="slider-slide h-full"><img src="${img}" class="w-full h-full object-contain" alt="Product Image"></div>`).join('')}</div></div><div id="product-detail-image-counter" class="absolute bottom-4 right-4 bg-black/70 text-white text-sm px-3 py-1 rounded-full"><i class="bi bi-camera-fill"></i> <span id="image-counter-text">1/${images.length}</span></div>`;
                 if (images.length > 1) { const actualSliderContainer = sliderContainer.querySelector('.slider-container'); initSlider(actualSliderContainer); }
            }
            
            window.shareProduct = async () => {
                if (!currentViewingAd) return showToast("No product selected.", "error");
                
                const shareData = {
                    title: currentViewingAd.title,
                    text: `Check out this item on Reoffy Pakistan: ${currentViewingAd.title}`,
                    url: `${window.location.origin}${window.location.pathname}#product=${currentViewingAd.id}`
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        await navigator.clipboard.writeText(shareData.url);
                        showToast("Link copied to clipboard!", "success");
                    }
                } catch (err) {
                    console.error("Share failed:", err);
                    if (err.name !== 'AbortError') {
                        showToast("Could not share product.", "error");
                    }
                }
            };
            
            function handleDeepLink() {
                const hash = window.location.hash;
                if (hash.startsWith('#product=')) {
                    const adId = hash.substring(9);
                    if (adId) {
                        const checkDataLoaded = setInterval(() => {
                            if (allAdsData.length > 0) {
                                clearInterval(checkDataLoaded);
                                viewProductDetail(adId);
                            }
                        }, 200);
                    }
                }
            }

            function autoFillReferralCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if (refCode) {
                    const referralInput = document.getElementById('signup-referral-code');
                    if (referralInput) {
                        referralInput.value = refCode;
                    }
                }
            }
            
            // --- INITIALIZATION ---
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); navigateTo(item.dataset.target); }));
            document.getElementById('buy-packages-banner-home').addEventListener('click', () => navigateTo('plans-screen'));
            
            showSkeletons(); // Show skeletons immediately on load
            fetchAndPopulateConfig();
            fetchAndDisplayEventBanner();
            autoFillReferralCode();
            
            // Handle initial navigation and deep links
            const initialHash = window.location.hash;
            if (initialHash.startsWith('#product=')) {
                handleDeepLink();
            } else {
                navigateTo('home-screen', true);
                history.replaceState({ screen: 'home-screen' }, '', '#home-screen');
            }
        });
    </script>
    
    <!-- Service Worker Registration (FIXED PATH) -->
    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(registration => {
              console.log('ServiceWorker registration successful');
            }).catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }
    </script>

</body>
</html>
